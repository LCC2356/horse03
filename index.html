<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HORSE RUNRUN - v7.74 SPEED TRAILS</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #111;
            --primary: #ffffff; 
            --panel: #222222;
            --border: #444444;
            --game-w: 3400px; 
            --game-h: 100px;
            --accent: #40e0d0;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: #0a0a0a; 
            font-family: 'VT323', monospace;
            color: var(--primary);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            position: relative;
        }

        .hidden { display: none !important; }

        #desktop-view {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background: #000;
        }

        #game-container {
            position: absolute;
            left: 50%; top: 50%;
            width: 0; height: 0;
            display: flex; justify-content: center; align-items: center;
        }

        #game-screen {
            width: var(--game-w); height: var(--game-h);
            background: #000; position: relative;
            border: 2px solid var(--primary); 
            border-right: none;
            box-shadow: none;
            overflow: hidden; 
            flex-shrink: 0; 
        }

        #track-wrapper {
            display: flex;
            width: calc(var(--game-w) + var(--game-h)); 
            height: var(--game-h);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        #side-qr-box {
            width: var(--game-h); 
            height: var(--game-h);
            background: #000;
            border: 2px solid var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .join-label {
            position: absolute; bottom: 2px; left: 0; width: 100%;
            text-align: center; font-size: 14px; color: #888;
            pointer-events: none; text-shadow: 1px 1px 0 #000;
        }
        
        .flash-active { animation: track-flash 0.2s ease-out; }
        @keyframes track-flash {
            0% { background-color: rgba(255, 255, 255, 0.4); box-shadow: inset 0 0 150px var(--primary); border-color: #fff; }
            100% { background-color: #000; box-shadow: none; border-color: var(--primary); }
        }

        .grid-bg {
            position: absolute; inset: 0; opacity: 0.2;
            background-image: linear-gradient(rgba(255, 255, 255, 0.3) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.3) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none;
        }
        .finish-line {
            position: absolute; top: 0; bottom: 0; right: 400px; width: 12px;
            background-image: linear-gradient(45deg, #fff 25%, transparent 25%, transparent 50%, #fff 50%, #fff 75%, transparent 75%, transparent);
            background-size: 12px 12px; opacity: 0.8; z-index: 0;
        }

        .hud { position: absolute; bottom: 4px; right: 10px; font-size: 32px; opacity: 0.5; letter-spacing: 2px; z-index: 110; }

        #track-display-bar {
            position: absolute; top: 50%; transform: translateY(-50%); left: 0; width: 100%; height: 100px; 
            display: none; align-items: center; justify-content: center; z-index: 100; pointer-events: none; 
        }
        .bar-container { width: 100%; display: flex; align-items: center; justify-content: center; }
        .bar-text-item {
            font-size: 80px; letter-spacing: 2px; text-shadow: 0 0 20px currentColor; font-weight: bold;
            width: 260px; display: flex; justify-content: center; flex-shrink: 0; margin: 0; 
            animation: text-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes text-pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1.0); opacity: 1; } }
        @keyframes text-vanish { 0% { opacity: 1; } 100% { opacity: 0; } }

        .queue-alert {
            position: absolute; top: 10px; right: 20px; font-size: 24px; color: #ffb300; text-shadow: 0 0 5px #ffb300; display: none; z-index: 20;
        }

        /* VFD Overlay */
        #vfd-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: flex-start; overflow: hidden; opacity: 0; pointer-events: none; z-index: 95; padding-left: 0; }
        #vfd-overlay i { display: inline-block; width: 0; height: 0; border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-left: 80px solid var(--primary); margin-right: 20px; flex-shrink: 0; opacity: 0; transform: scale(0.8) skewX(-20deg); filter: drop-shadow(0 0 5px var(--primary)); }
        .vfd-active { opacity: 1 !important; }
        .vfd-active i { animation: vfd-flash 0.4s ease-out forwards calc(var(--d) * 1s); }
        @keyframes vfd-flash {
            0% { opacity: 0; transform: scale(0.8) translateX(0); }
            10% { opacity: 1; transform: scale(1.2) translateX(10px); filter: drop-shadow(0 0 15px var(--primary)) drop-shadow(0 0 30px #fff); }
            40% { opacity: 0.3; transform: scale(1.0) translateX(20px); }
            100% { opacity: 0; transform: scale(0.8) translateX(30px); }
        }

        .entity { position: absolute; width: 44px; height: 44px; will-change: transform; }
        /* Winner Z-Index Override */
        .entity.winner { z-index: 200 !important; }

        .pixel-grid { display: grid; grid-template-columns: repeat(11, 1fr); width: 100%; height: 100%; transform-origin: bottom center; transition: transform 0.2s; }
        
        .crown-container { position: absolute; top: -31px; left: 50%; transform: translateX(-50%); width: 18px; height: 18px; animation: bounce 1s infinite; z-index: 10; display: flex; flex-direction: column-reverse; align-items: center; }
        .aura { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160%; height: 160%; border-radius: 50%; background: radial-gradient(circle, rgba(250,204,21,0.4) 0%, transparent 70%); box-shadow: 0 0 10px #facc15; z-index: -1; animation: pulse 0.5s infinite alternate; display: none; }
        @keyframes pulse { from { opacity: 0.5; transform: translate(-50%, -50%) scale(1); } to { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } }
        
        .name-tag { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 20px; white-space: nowrap; color: #40e0d0; text-shadow: 1px 1px 0 #000; }
        .grass { position: absolute; width: 6px; height: 6px; background: #69f0ae; box-shadow: 0 0 4px #69f0ae; }
        .explosion { position: absolute; width: 6px; height: 6px; background: #ff5252; pointer-events: none; }
        
        /* Particle Effects */
        .dust { position: absolute; width: 4px; height: 4px; background: #ddd; opacity: 0.8; pointer-events: none; animation: dust-fade 0.5s linear forwards; }
        @keyframes dust-fade { 0% { opacity: 0.8; transform: scale(1); } 100% { opacity: 0; transform: translate(-10px, -5px) scale(0.2); } }

        /* New: Neon Trail */
        .trail-ghost { position: absolute; width: 44px; height: 44px; opacity: 0.5; pointer-events: none; mix-blend-mode: screen; animation: trail-vanish 0.3s ease-out forwards; }
        @keyframes trail-vanish { 0% { opacity: 0.6; transform: scale(1); } 100% { opacity: 0; transform: scale(0.9) translateX(-20px); } }

        /* Modified: Smaller Pixel Emoji */
        .emoji-bubble {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            font-size: 16px; /* Smaller */
            animation: bubble-float 2s ease-out forwards; pointer-events: none; z-index: 200;
            text-shadow: 0 0 2px #000;
            filter: contrast(1.5); /* Pop */
        }
        @keyframes bubble-float { 
            0% { opacity: 0; transform: translateX(-50%) translateY(5px) scale(0.5); } 
            10% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(-15px); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-25px); } 
        }

        @keyframes bounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -4px); } }

        /* Controls */
        #bottom-controls { position: fixed; bottom: 20px; left: 20px; display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(0, 0, 0, 0.85); border: 1px solid var(--border); border-radius: 8px; z-index: 1000; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        #qrcode { background: white; padding: 3px; width: 90px; height: 90px; display: flex; justify-content: center; align-items: center; border-radius: 2px; }
        #qrcode img { display: block; width: 100%; height: 100%; }

        .control-group { display: flex; flex-direction: column; gap: 5px; border-left: 1px solid #333; padding-left: 15px; width: 140px; }
        .control-label { font-size: 0.8rem; color: #888; letter-spacing: 1px; }
        .input-wrapper { display: flex; align-items: center; gap: 5px; width: 100%; }
        .stepper { display: flex; align-items: center; gap: 5px; width: 100%; }
        .btn-step { background: #222; border: 1px solid var(--primary); color: var(--primary); width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-family: 'VT323', monospace; font-size: 1.2rem; transition: all 0.1s; }
        .btn-step:hover { background: #333; }
        .btn-step:active { background: var(--primary); color: #000; transform: scale(0.95); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #333; border-radius: 3px; border: 1px solid #555; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 2px; background: var(--accent); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 5px var(--accent); }
        
        input[type="number"] { background: #222; border: 1px solid var(--border); color: var(--primary); font-family: 'VT323', monospace; font-size: 1.4rem; width: 60px; text-align: center; padding: 2px; border-radius: 4px; }
        .unit-label { font-size: 1.2rem; color: #555; }
        
        .btn { background: #222; border: 2px solid var(--primary); color: var(--primary); padding: 10px 20px; font-family: 'VT323', monospace; font-size: 1.2rem; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); transition: all 0.2s; margin-left: 5px; }
        .btn:hover { background: var(--primary); color: #000; }
        .btn:active { transform: translateY(2px); }

        #modal-editor { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #1a1c20; border: 2px solid var(--primary); padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        /* ‰øÆÂ§çÁÇπÔºöÂº∫Âà∂ Editor Grid Â∞∫ÂØ∏ÔºåÁ°Æ‰øùÁîªÊùø‰∏çÊ∂àÂ§± */
        .editor-grid { 
            display: grid; 
            grid-template-columns: repeat(11, 28px); 
            grid-template-rows: repeat(11, 28px); 
            gap: 2px; background: #333; border: 2px solid #555; 
            touch-action: none; margin: 0 auto;
        }
        .editor-cell { width: 28px; height: 28px; background: #000; }
        
        .color-picker { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .c-dot { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; }
        .c-dot.active { border-color: white; transform: scale(1.1); }
        .btn-outline { background: transparent; border-color: #ff5252; color: #ff5252; }
        .btn-flex { flex: 1; display: flex; justify-content: center; align-items: center; }

        #mobile-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; z-index: 20000; padding: 20px; }
        .m-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; flex-shrink: 0; }
        .m-title { font-size: 1.5rem; color: #fff; }
        .m-status { background: #222; padding: 4px 8px; border-radius: 4px; font-size: 1rem; color: #fff; border: 1px solid #444; }
        .m-controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; flex-shrink: 0; }
        input[type="text"] { background: #222; border: 1px solid #444; color: white; padding: 12px; font-family: inherit; text-align: center; font-size: 1.5rem; width: 100%; border-radius: 4px; }
        .m-canvas-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #1a1a1a; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .m-footer { display: flex; gap: 15px; height: 60px; flex-shrink: 0; width: 100%; }

        #m-controller { position: fixed; inset: 0; background: #111; z-index: 22000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .push-btn { width: 250px; height: 250px; border-radius: 50%; background: #222; border: 8px solid #444; color: #888; font-size: 4rem; font-family: 'VT323', monospace; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 50px rgba(0,0,0, 0.4); transition: all 0.2s; user-select: none; cursor: pointer; -webkit-tap-highlight-color: transparent; text-align: center; line-height: 1; padding: 20px; margin-bottom: 30px; }
        .push-btn:active { transform: scale(0.95); }
        .controller-info { font-size: 1.5rem; color: #888; margin-bottom: 20px; text-align: center; }
        
        .emoji-bar { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; width: 100%; max-width: 320px; }
        .btn-emoji { font-size: 1.5rem; background: #333; border: 1px solid #555; border-radius: 8px; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .btn-emoji:active { transform: scale(0.9); background: #555; }

        .btn-wait { background: #1a1a1a !important; border-color: #333 !important; color: #555 !important; }
        .btn-mash { background: #fff !important; border-color: #ccc !important; color: #000 !important; box-shadow: 0 0 60px rgba(255, 255, 255, 0.6) !important; }
        .btn-start { background: #e65100 !important; border-color: #ffb300 !important; color: #fff !important; box-shadow: 0 0 50px rgba(255, 179, 0, 0.4) !important; }

        #m-success-modal { display: none; } 
    </style>
</head>
<body>

    <div id="desktop-view">
        <div id="game-container">
            <div id="track-wrapper">
                <div id="game-screen">
                    <div class="grid-bg"></div>
                    <div class="finish-line"></div>
                    
                    <div id="hud" class="hud">NOWHERE TO RUN</div>

                    <div id="track-display-bar">
                        <div class="bar-container" id="bar-text"></div>
                    </div>

                    <div id="queue-text" class="queue-alert"></div>
                    
                    <div id="vfd-overlay"></div>

                    <div id="layer-grass"></div>
                    <div id="layer-pony"></div>
                    <div id="layer-fx"></div>
                </div>
                <div id="side-qr-box">
                    <div id="qrcode"></div>
                    <div class="join-label">JOIN</div>
                </div>
            </div>
        </div>

        <div id="bottom-controls">
            <div class="control-group" style="border-left: none;">
                <span class="control-label">ZOOM</span>
                <input type="range" id="zoom-slider" min="1" max="500" step="1" value="100">
                <div class="input-wrapper">
                    <input type="number" id="zoom-input" value="100" min="1" max="500">
                    <span class="unit-label">%</span>
                </div>
            </div>

            <div class="control-group">
                <span class="control-label">Y OFFSET</span>
                <input type="range" id="y-slider" min="-1200" max="1200" step="10" value="0">
                <div class="input-wrapper">
                    <div class="stepper">
                        <button class="btn-step" onclick="adjustY(-50)">&lt;</button>
                        <input type="number" id="y-input" value="0" step="1">
                        <button class="btn-step" onclick="adjustY(50)">&gt;</button>
                    </div>
                    <span class="unit-label">PX</span>
                </div>
            </div>

            <button class="btn" onclick="spawnTestPony()">+ BOT</button>
            <button class="btn" onclick="openDesktopEditor()">+ PONY</button>
        </div>
    </div>

    <div id="modal-editor" class="hidden">
        <div class="modal-content">
            <h2 class="vfd-glow" style="margin:0;">DESIGN RUNNER</h2>
            <input type="text" id="pc-name" placeholder="ENTER NAME" maxlength="8" value="PLAYER" style="background:#222; border:1px solid #444; color:white; padding:10px; text-align:center; font-size:1.5rem; border-radius:4px;">
            <div class="color-picker" id="pc-colors"></div>
            <div id="pc-grid" class="editor-grid"></div>
            <div style="display: flex; gap: 20px; width: 100%;">
                <button class="btn btn-outline btn-flex" onclick="document.getElementById('modal-editor').style.display='none'">CANCEL</button>
                <button class="btn btn-outline btn-flex" style="border-color:#ffb300; color:#ffb300;" onclick="clearDesktop()">CLEAR</button>
                <button class="btn btn-flex" onclick="savePCPony()">SPAWN</button>
            </div>
        </div>
    </div>

    <div id="mobile-view" style="display: none;">
        <div id="m-editor-ui">
            <div class="m-header">
                <span class="m-title">PIXEL MAKER</span>
                <span id="m-status" class="m-status">Wait...</span>
            </div>
            <div class="m-controls">
                <input type="text" id="m-name" placeholder="ENTER NAME" maxlength="8">
                <div class="color-picker" id="m-colors"></div>
            </div>
            <div class="m-canvas-container">
                <div id="m-grid" class="editor-grid"></div>
            </div>
            <div class="m-footer">
                <button class="btn btn-outline btn-flex" onclick="clearMobile()">CLEAR CANVAS</button>
                <button class="btn btn-flex" onclick="sendMobile()">RUN</button>
            </div>
        </div>

        <div id="m-controller">
            <div id="m-info" class="controller-info">GET READY</div>
            <div id="m-btn" class="push-btn btn-wait" ontouchstart="btnAction(event)" onmousedown="btnAction(event)">WAIT</div>
            
            <div class="emoji-bar">
                <div class="btn-emoji" onclick="sendEmoji('üòÇ')">üòÇ</div>
                <div class="btn-emoji" onclick="sendEmoji('üò°')">üò°</div>
                <div class="btn-emoji" onclick="sendEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                <div class="btn-emoji" onclick="sendEmoji('üê¥')">üê¥</div>
                <div class="btn-emoji" onclick="sendEmoji('üí©')">üí©</div>
            </div>
        </div>
    </div>

    <script>
        const GAME_W = 3400; 
        const GAME_H = 100;
        const PONY_SIZE = 50; 
        const FINISH_X = GAME_W - 400;

        const COLORS = { CYAN:'#40e0d0', YELLOW:'#ffb300', RED:'#ff5252', GREEN:'#69f0ae', PURPLE:'#e040fb', WHITE:'#ffffff', BLUE:'#2979ff' };
        
        const DEFAULT_PIXELS = [
            [0,0,0,0,0,0,0,0,0,0,0], 
            [0,0,0,0,0,0,0,0,1,0,0], 
            [0,0,0,0,0,0,0,1,1,1,0], 
            [0,0,0,0,0,0,0,1,1,1,1], 
            [0,1,0,0,0,0,1,1,1,0,0], 
            [1,0,1,1,1,1,1,1,1,0,0], 
            [1,0,1,1,1,1,1,1,1,0,0], 
            [0,0,1,1,1,1,1,1,1,0,0], 
            [0,0,1,0,1,0,1,0,1,0,0], 
            [0,0,1,0,1,0,1,0,1,0,0], 
            [0,0,1,0,1,0,1,0,1,0,0]  
        ];

        let ponies = [];
        let ponyQueue = []; 
        let grass = [];
        let gameState = 'ROAMING';
        let cooldownTimer = 0;
        let waitTimer = 0;
        
        let peer = null, conn = null;
        let pcGrid = JSON.parse(JSON.stringify(DEFAULT_PIXELS));
        let mobileGrid = JSON.parse(JSON.stringify(DEFAULT_PIXELS));
        let selectedColor = COLORS.CYAN;
        let playerUUID = null;

        let mobileBtnState = 'wait';
        let audioCtx = null;
        let lastTapTime = 0;
        let mySoundType = 'SAWTOOTH'; 
        const SOUND_TYPES = ['SAWTOOTH', 'LASER', 'SQUARE', 'FM'];

        let layout = { scale: 1.0, x: 0, y: 0 };
        let currentBarText = '';
        let lastBroadcastText = '';

        const PEER_CONFIG = {
            debug: 2,
            config: { 'iceServers': [ { url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' } ] }
        };

        function updateBarText(text, color) {
            if (currentBarText === text) return;
            currentBarText = text;
            const container = document.getElementById('bar-text');
            let content = '';
            for(let i=0; i<12; i++) { content += `<span class="bar-text-item">${text}</span>`; }
            container.innerHTML = content;
            if(color) container.style.color = color; else container.style.color = '';
        }

        function setBarVisibility(show) {
            const bar = document.getElementById('track-display-bar');
            if(show) bar.style.display = 'flex'; else { bar.style.display = 'none'; currentBarText = ''; }
        }
        
        function triggerFlash() {
            const screen = document.getElementById('track-wrapper');
            screen.classList.remove('flash-active'); void screen.offsetWidth; screen.classList.add('flash-active');
        }

        function broadcast(data) {
            if(!peer || !peer.connections) return;
            Object.values(peer.connections).forEach(conns => {
                conns.forEach(conn => { if(conn.open) conn.send(data); });
            });
        }

        window.onload = function() {
            const zoomSlider = document.getElementById('zoom-slider');
            const zoomInput = document.getElementById('zoom-input');
            const ySlider = document.getElementById('y-slider');
            const yInput = document.getElementById('y-input');

            zoomSlider.oninput = function() { zoomInput.value = this.value; layout.scale = this.value / 100; applyLayout(false); };
            zoomInput.oninput = function() { let val = parseFloat(this.value); if(val) { zoomSlider.value = val; layout.scale = val / 100; applyLayout(false); } };
            ySlider.oninput = function() { yInput.value = this.value; layout.y = parseFloat(this.value); applyLayout(false); };
            yInput.oninput = function() { let val = parseFloat(this.value); if(!isNaN(val)) { ySlider.value = val; layout.y = val; applyLayout(false); } };

            const gameContainer = document.getElementById('desktop-view');
            gameContainer.addEventListener('wheel', (e) => {
                e.preventDefault(); 
                if (e.ctrlKey) {
                    const zoomSpeed = 0.001; const newScale = layout.scale - (e.deltaY * zoomSpeed);
                    layout.scale = Math.min(Math.max(0.1, newScale), 5.0);
                } else {
                    const panSpeed = 1.0; layout.y -= e.deltaY * panSpeed;
                }
                applyLayout(true);
            }, { passive: false });

            const vfdOverlay = document.getElementById('vfd-overlay');
            for (let i = 0; i < 80; i++) { const arrow = document.createElement('i'); arrow.style.setProperty('--d', i * 0.01); vfdOverlay.appendChild(arrow); }

            requestAnimationFrame(gameLoop); fitScreen();
            
            window.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;
                const step = 20 / layout.scale; const zoomStep = 0.05; let changed = false;
                switch(e.key) {
                    case 'ArrowUp': layout.y -= step; changed = true; break;
                    case 'ArrowDown': layout.y += step; changed = true; break;
                    case 'ArrowLeft': layout.x -= step; changed = true; break;
                    case 'ArrowRight': layout.x += step; changed = true; break;
                    case '=': case '+': layout.scale += zoomStep; changed = true; break;
                    case '-': case '_': layout.scale = Math.max(0.1, layout.scale - zoomStep); changed = true; break;
                    case '0': fitScreen(); return; 
                }
                if(changed) applyLayout(true); 
            });

            const isMobile = new URLSearchParams(window.location.search).has('host');
            if(isMobile) { document.getElementById('desktop-view').style.display = 'none'; document.getElementById('mobile-view').style.display = 'flex'; initMobile(); } else { initDesktop(); }
        };

        function adjustY(delta) { layout.y += delta; applyLayout(true); }

        function fitScreen() { const availableW = window.innerWidth * 0.95; layout.scale = Math.min(availableW / (GAME_W + GAME_H), 1); layout.x = 0; layout.y = 0; applyLayout(true); }

        function applyLayout(updateInput = true) {
            const el = document.getElementById('track-wrapper');
            el.style.transform = `scale(${layout.scale}) translate(${layout.x}px, ${layout.y}px)`;
            if(updateInput) {
                document.getElementById('zoom-input').value = Math.round(layout.scale * 100);
                document.getElementById('zoom-slider').value = Math.round(layout.scale * 100);
                document.getElementById('y-input').value = Math.round(layout.y);
                document.getElementById('y-slider').value = Math.round(layout.y);
            }
        }

        function initDesktop() {
            initEditor('pc-grid', 'pc-colors', pcGrid);
            try {
                peer = new Peer(null, PEER_CONFIG);
                peer.on('open', id => {
                    const url = `${location.href}?host=${id}`;
                    new QRCode(document.getElementById("qrcode"), { text: url, width: 86, height: 86, colorDark : "#000000", colorLight : "#ffffff", correctLevel: QRCode.CorrectLevel.L });
                });
                peer.on('connection', c => {
                    c.on('data', data => {
                        if (data.type === 'check_reconnect') {
                            const uuid = data.uuid; const exists = ponies.find(p => p.playerUUID === uuid) || ponyQueue.find(p => p.playerUUID === uuid);
                            if (exists) c.send({ type: 'reconnect_success' });
                        }
                        else if (data.type === 'spawn') {
                            const uuid = data.payload.uuid;
                            const exists = ponies.find(p => p.playerUUID === uuid) || ponyQueue.find(p => p.playerUUID === uuid);
                            if (!exists) requestSpawnPony(data.payload.name, data.payload.pixels, data.payload.color, uuid);
                        } 
                        else if (data.type === 'tap') handleTap(data.uuid);
                        else if (data.type === 'force_start') { if (gameState === 'ROAMING' || gameState === 'WAITING_TO_START') startCooldown(); }
                        else if (data.type === 'emoji') showEmoji(data.uuid, data.emoji);
                    });
                });
                peer.on('error', (err) => { console.error("PeerJS Error:", err); alert("Network Error: " + err.type + "\nTry refreshing."); });
            } catch(e) { console.error(e); }
        }

        function spawnTestPony() {
            const names = ["SPEEDY", "THUNDER", "BOLT", "COMET", "DASH", "FLASH", "STORM", "SHADOW", "BLAZE", "SPIRIT"];
            const rName = names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random()*99);
            const colorKeys = Object.keys(COLORS); const rColorKey = colorKeys[Math.floor(Math.random() * colorKeys.length)]; const rColor = COLORS[rColorKey];
            requestSpawnPony(rName, DEFAULT_PIXELS, rColor, null);
        }
        function showEmoji(uuid, emoji) {
            const pony = ponies.find(p => p.playerUUID === uuid);
            if (pony) {
                const el = document.getElementById(pony.id);
                if (el) {
                    const bubble = document.createElement('div'); bubble.className = 'emoji-bubble'; bubble.innerText = emoji;
                    el.appendChild(bubble); setTimeout(() => bubble.remove(), 2000);
                }
            }
        }
        function handleTap(uuid) {
            if (!uuid) return; const pony = ponies.find(p => p.playerUUID === uuid);
            if (pony && pony.state === 'racing') {
                pony.isManual = true; pony.lastTapTime = Date.now(); pony.tapCount++; pony.name = pony.name.replace(" (BOT)", "");
                pony.manualSpeed = Math.min(pony.manualSpeed + 2.9, 22);
                if (pony.manualAnimTimer === 0) pony.manualAnimTimer = 10; 
            }
        }
        function requestSpawnPony(name, pixels, color, uuid = null) {
            const newPony = {
                id: Math.random().toString(36).substr(2, 9), playerUUID: uuid, isManual: !!uuid, manualSpeed: 0, tapCount: 0, lastTapTime: Date.now(), 
                name: name || 'PONY', pixels: JSON.parse(JSON.stringify(pixels || DEFAULT_PIXELS)), color: color || COLORS.CYAN, x: 20, y: 30 + Math.random() * (GAME_H - PONY_SIZE - 20),
                speed: 3.0, state: 'racing', hasCrown: false, isStreak: false, crownCount: 0, timer: 0, frame: 0, finishedWalking: false, targetX: null, targetY: null, isWalkAnimating: false, manualAnimTimer: 0, roamSpeed: 0.5 
            };
            if (gameState === 'RACING' || gameState === 'COOLDOWN' || gameState === 'WAITING_TO_START') { ponyQueue.push(newPony); updateHUD(); } 
            else { ponies.push(newPony); startCooldown(); }
        }
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playDynamicSound(interval) {
            if (!audioCtx) return; const now = audioCtx.currentTime; let baseFreq = 150 + (30000 / Math.max(50, interval)); if (baseFreq > 800) baseFreq = 800;
            const gain = audioCtx.createGain(); gain.connect(audioCtx.destination); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            if (mySoundType === 'SAWTOOTH') { const osc = audioCtx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(baseFreq, now); osc.connect(gain); osc.start(); osc.stop(now + 0.15); } 
            else if (mySoundType === 'SQUARE') { const osc = audioCtx.createOscillator(); osc.type = 'square'; osc.frequency.setValueAtTime(baseFreq, now); osc.connect(gain); osc.start(); osc.stop(now + 0.1); }
            else if (mySoundType === 'LASER') { const osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(baseFreq * 2, now); osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.5, now + 0.1); osc.connect(gain); osc.start(); osc.stop(now + 0.15); }
            else if (mySoundType === 'FM') { const carrier = audioCtx.createOscillator(); const modulator = audioCtx.createOscillator(); const modGain = audioCtx.createGain(); modulator.frequency.value = baseFreq * 1.4; modGain.gain.value = baseFreq * 0.5; modulator.connect(modGain); modGain.connect(carrier.frequency); carrier.connect(gain); carrier.frequency.setValueAtTime(baseFreq, now); modulator.start(); carrier.start(); modulator.stop(now + 0.2); carrier.stop(now + 0.2); }
        }
        function btnAction(e) {
            e.preventDefault(); const btn = document.getElementById('m-btn'); btn.style.transform = 'scale(0.95)'; setTimeout(() => { btn.style.transform = 'scale(1)'; }, 50);
            if (mobileBtnState === 'mash') { if(conn) conn.send({ type: 'tap', uuid: playerUUID }); const now = Date.now(); const interval = now - lastTapTime; lastTapTime = now; playDynamicSound(interval); } 
            else if (mobileBtnState === 'start') { if(conn) conn.send({ type: 'force_start' }); }
        }
        function resetMobile() { document.getElementById('m-controller').style.display = 'none'; document.getElementById('m-editor-ui').style.display = 'block'; document.getElementById('m-name').value = ''; restoreGridData(mobileGrid); renderGrid('m-grid', mobileGrid, selectedColor); }
        function clearMobile() { clearGridData(mobileGrid); renderGrid('m-grid', mobileGrid, selectedColor); }
        function clearDesktop() { clearGridData(pcGrid); renderGrid('pc-grid', pcGrid, selectedColor); }
        function clearGridData(grid) { for(let r=0; r<11; r++) for(let c=0; c<11; c++) grid[r][c] = 0; }
        function restoreGridData(grid) { for(let r=0; r<11; r++) for(let c=0; c<11; c++) grid[r][c] = DEFAULT_PIXELS[r][c]; }
        function openDesktopEditor() { renderGrid('pc-grid', pcGrid, selectedColor); document.getElementById('modal-editor').style.display = 'flex'; }
        function savePCPony() { let name = document.getElementById('pc-name').value.trim().replace(/[^a-zA-Z0-9]/g, ''); if (!name) name = "PLAYER"; name = name.toUpperCase(); requestSpawnPony(name, pcGrid, selectedColor); document.getElementById('modal-editor').style.display = 'none'; }
        function initEditor(gridId, colorId, dataGrid) {
            const gridEl = document.getElementById(gridId); const colorEl = document.getElementById(colorId); colorEl.innerHTML = '';
            Object.values(COLORS).forEach(c => {
                const dot = document.createElement('div'); dot.className = `c-dot ${c === selectedColor ? 'active' : ''}`; dot.style.background = c;
                dot.onclick = () => { selectedColor = c; renderGrid(gridId, dataGrid, selectedColor); Array.from(colorEl.children).forEach(d => d.classList.remove('active')); dot.classList.add('active'); };
                colorEl.appendChild(dot);
            });
            renderGrid(gridId, dataGrid, selectedColor);
            let drawing = false, eraseMode = false;
            const getCellCoords = (e) => { const t = e.touches ? e.touches[0] : e; const el = document.elementFromPoint(t.clientX, t.clientY); if (el && el.classList.contains('editor-cell')) { return { r: parseInt(el.dataset.r), c: parseInt(el.dataset.c), el: el }; } return null; };
            const startDraw = (e) => { if(e.cancelable) e.preventDefault(); drawing = true; const cell = getCellCoords(e); if (cell) { eraseMode = dataGrid[cell.r][cell.c] === 1; updateCell(cell.r, cell.c, cell.el); } };
            const moveDraw = (e) => { if (!drawing) return; if(e.cancelable) e.preventDefault(); const cell = getCellCoords(e); if (cell) { updateCell(cell.r, cell.c, cell.el); } };
            const endDraw = () => { drawing = false; };
            const updateCell = (r, c, el) => { const targetVal = eraseMode ? 0 : 1; if (dataGrid[r][c] !== targetVal) { dataGrid[r][c] = targetVal; if (targetVal === 1) { el.style.background = selectedColor; el.style.boxShadow = `0 0 5px ${selectedColor}`; } else { el.style.background = '#000'; el.style.boxShadow = 'none'; } } };
            gridEl.onmousedown = gridEl.ontouchstart = startDraw; window.onmousemove = window.ontouchmove = moveDraw; window.onmouseup = window.ontouchend = endDraw;
        }
        function renderGrid(id, data, color) {
            const el = document.getElementById(id); el.innerHTML = '';
            data.forEach((row, r) => row.forEach((val, c) => {
                const cell = document.createElement('div'); cell.className = 'editor-cell'; cell.dataset.r = r; cell.dataset.c = c;
                if(val) { cell.style.background = color; cell.style.boxShadow = `0 0 5px ${color}`; } else { cell.style.background = '#000'; }
                el.appendChild(cell);
            }));
        }
    </script>
</body>
</html>
