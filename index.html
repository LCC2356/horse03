<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HORSE RUNRUN</title>
    <!-- PeerJS for P2P connection -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- QRCodeJS for generating QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- VT323 Font for retro look -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg: #111;
            --color-primary: #40e0d0; /* Turquoise */
            --color-panel: #004d40;
            --color-border: #00695c;
            --color-border-dark: #00251a;
            --scale: 4px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            font-family: 'VT323', monospace;
            color: var(--color-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .vfd-glow { text-shadow: 0 0 5px rgba(64, 224, 208, 0.6), 0 0 10px rgba(64, 224, 208, 0.4); }
        .btn {
            background: #00251a;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            padding: 10px 20px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(64, 224, 208, 0.2);
            transition: all 0.2s;
        }
        .btn:hover { background: var(--color-primary); color: #00251a; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Background Grid */
        .bg-grid {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            pointer-events: none;
            background-image: linear-gradient(var(--color-border) 1px, transparent 1px), 
                              linear-gradient(90deg, var(--color-border) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }

        /* --- Main Game Screen --- */
        #game-container {
            position: relative;
            transform-origin: center;
            transform: scale(1);
        }

        .screen-frame {
            width: 1000px;
            height: 120px;
            background: var(--color-panel);
            border-top: 1px solid var(--color-border);
            border-left: 1px solid var(--color-border);
            border-right: 4px solid var(--color-border-dark);
            border-bottom: 4px solid var(--color-border-dark);
            position: relative;
            border-radius: 4px;
            box-shadow: 0 0 50px rgba(64, 224, 208, 0.1);
        }

        .screen-glass {
            position: absolute;
            inset: 2px;
            background: #000;
            border: 1px solid #222;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }

        .screen-grid {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            background-image: radial-gradient(var(--color-primary) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* Screws */
        .screw {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #1a1c20;
            border: 1px solid var(--color-border);
            border-radius: 50%;
        }
        .tl { top: 2px; left: 2px; } .tr { top: 2px; right: 2px; }
        .bl { bottom: 2px; left: 2px; } .br { bottom: 2px; right: 2px; }

        /* Start Line */
        .start-line {
            position: absolute;
            top: 0; bottom: 0; left: 12px;
            width: 1px;
            border-left: 2px dashed rgba(64, 224, 208, 0.3);
        }

        /* HUD Text */
        .hud {
            position: absolute;
            bottom: 4px; right: 8px;
            font-size: 10px;
            opacity: 0.4;
            letter-spacing: 2px;
        }

        /* --- Entities (Pony/Grass) --- */
        .entity {
            position: absolute;
            will-change: transform;
        }

        .pixel-grid-container {
            width: 32px;
            height: 32px;
            transition: transform 0s; /* Instant flip */
        }

        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 32px; /* 8 cols * 4px scale */
            height: 32px;
        }
        
        .pixel {
            width: 4px;
            height: 4px;
        }

        /* Crown Animation */
        @keyframes crown-float {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -8px); }
        }

        .crown {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #facc15; /* Yellow */
            font-size: 24px;
            animation: crown-float 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 5px rgba(250, 204, 21, 0.8));
            z-index: 1000;
            display: block !important; /* Force show if class present */
        }

        .name-tag {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
            opacity: 0.8;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .grass {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: #69f0ae;
            box-shadow: 0 0 4px #69f0ae;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1c20;
            border: 2px solid var(--color-primary);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(64, 224, 208, 0.3);
            text-align: center;
            max-width: 90%;
        }

        /* Editor */
        .editor-grid {
            display: grid;
            grid-template-rows: repeat(8, 1fr);
            gap: 1px;
            background: #222;
            padding: 4px;
            border: 1px solid var(--color-border);
            margin: 20px auto;
            width: fit-content;
        }
        .editor-row { display: flex; gap: 1px; }
        .editor-cell {
            width: 30px;
            height: 30px;
            background: #001a15;
            border: 1px solid #333;
            cursor: pointer;
        }
        .editor-cell.active {
            opacity: 1;
            box-shadow: 0 0 4px currentColor;
        }

        .color-picker {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.selected { border-color: white; transform: scale(1.2); }

        /* Mobile View */
        #mobile-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #000;
            padding: 20px;
        }

        input[type="text"] {
            background: #00251a;
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            padding: 8px;
            font-family: inherit;
            text-align: center;
            font-size: 1.2rem;
            width: 200px;
            margin-bottom: 10px;
        }
        input:focus { outline: none; border-color: var(--color-primary); }

        /* QR Code HUD (Bottom Right) */
        #qr-hud {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(64, 224, 208, 0.2);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        #qr-hud:hover { opacity: 1; }
        #qrcode img { margin: 0 auto; }
        .qr-label {
            color: #000;
            font-size: 12px;
            margin-top: 5px;
            font-weight: bold;
            letter-spacing: 1px;
        }

    </style>
</head>
<body>

    <!-- Background -->
    <div class="bg-grid"></div>

    <!-- ===== DESKTOP VIEW ===== -->
    <div id="desktop-view">
        <div style="position: absolute; top: 40px; width: 100%; text-align: center;">
            <h1 class="vfd-glow" style="font-size: 4rem; margin: 0; letter-spacing: 0.2em;">HORSE RUNRUN</h1>
            <p style="color: var(--color-border); letter-spacing: 2px;">ADD RUNNER TO START RACE</p>
        </div>

        <div id="game-container">
            <div class="screen-frame">
                <div class="screw tl"></div><div class="screw tr"></div>
                <div class="screw bl"></div><div class="screw br"></div>
                
                <div class="screen-glass" id="screen-glass">
                    <div class="screen-grid"></div>
                    <div class="start-line"></div>
                    <div class="hud">MODE:RACE // STATUS:LIVE</div>
                    
                    <!-- Layers -->
                    <div id="grass-layer"></div>
                    <div id="pony-layer"></div>
                </div>
            </div>
        </div>

        <div style="position: absolute; bottom: 40px; display: flex; gap: 20px;">
            <button class="btn" onclick="openEditor()">+ NEW RUNNER</button>
        </div>

        <!-- Persistent QR HUD -->
        <div id="qr-hud" class="hidden">
            <div id="qrcode"></div>
            <div class="qr-label">SCAN TO DRAW</div>
        </div>
    </div>

    <!-- ===== MOBILE VIEW ===== -->
    <div id="mobile-view" class="hidden">
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--color-border); padding-bottom: 10px;">
            <span style="font-size: 1.5rem;" class="vfd-glow">REMOTE DRAW</span>
            <span id="mobile-status" style="background: #004d40; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">CONNECTING</span>
        </div>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; overflow: auto;">
            <div id="mobile-editor-container"></div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
            <div class="color-picker" id="mobile-color-picker"></div>
            <input type="text" id="mobile-name-input" placeholder="NAME" maxlength="8">
            <button class="btn" style="width: 100%;" onclick="sendPonyFromMobile()">CAST TO SCREEN</button>
        </div>
    </div>

    <!-- ===== EDITOR MODAL ===== -->
    <div id="modal-editor" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="vfd-glow" style="margin-top: 0;">// ENTITY DESIGNER</h2>
            <input type="text" id="editor-name" placeholder="NAME" maxlength="8" value="CUSTOM">
            
            <div class="color-picker" id="desktop-color-picker"></div>
            
            <div id="desktop-editor-grid" class="editor-grid"></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn" style="border-color: #ff5252; color: #ff5252;" onclick="clearEditor()">CLEAR</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="border-color: transparent;" onclick="closeEditor()">CANCEL</button>
                    <button class="btn" onclick="savePony()">CREATE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const SCREEN_WIDTH = 1000;
        const SCREEN_HEIGHT = 120;
        const PONY_SCALE = 4;
        const PONY_WIDTH = 8 * PONY_SCALE; 
        const PONY_HEIGHT = 8 * PONY_SCALE;
        
        const COLORS = {
            TURQUOISE: '#40e0d0',
            AMBER: '#ffb300',
            RED: '#ff5252',
            GREEN: '#69f0ae',
            PURPLE: '#e040fb',
            WHITE: '#ffffff'
        };

        // --- DEFAULT PIXEL ART (8x8) ---
        const DEFAULT_FRAME_1 = [
            [0,0,0,0,0,1,0,0],
            [0,0,0,0,1,1,1,1],
            [0,0,0,0,1,1,1,0],
            [0,0,1,1,1,1,1,0],
            [1,0,1,1,1,1,1,0],
            [1,1,1,1,1,1,1,0],
            [0,0,1,0,0,0,1,0],
            [0,0,1,0,0,0,1,0]
        ];

        // --- STATE ---
        let ponies = []; 
        let grass = [];  
        let peerId = null;
        let peer = null;
        let conn = null; 
        
        let editorGrid = JSON.parse(JSON.stringify(DEFAULT_FRAME_1));
        let selectedColor = COLORS.TURQUOISE;

        // --- INIT ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            const connectTo = params.get('connectTo');

            if (connectTo) {
                document.getElementById('desktop-view').classList.add('hidden');
                document.getElementById('mobile-view').classList.remove('hidden');
                initMobile(connectTo);
            } else {
                initDesktop();
            }
        }

        // --- DESKTOP LOGIC ---
        function initDesktop() {
            initPeerHost();
            buildColorPicker('desktop-color-picker');
            buildEditorGrid('desktop-editor-grid');
            requestAnimationFrame(gameLoop);
        }

        function initPeerHost() {
            peer = new Peer();
            peer.on('open', (id) => {
                peerId = id;
                generateQR(); // Auto generate QR HUD
            });
            peer.on('connection', (c) => {
                c.on('data', (data) => {
                    createPony(data.name, data.pixels, data.color);
                });
            });
        }

        function generateQR() {
            if (!peerId) return;
            const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?connectTo=${peerId}`;
            const container = document.getElementById('qrcode');
            container.innerHTML = '';
            
            // Generate QR Code
            new QRCode(container, {
                text: url,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });
            
            // Show HUD
            document.getElementById('qr-hud').classList.remove('hidden');
        }

        // --- PHYSICS ENGINE ---
        function gameLoop() {
            updatePhysics();
            render();
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics() {
            const totalPonies = ponies.length;
            const finishedPonies = ponies.filter(p => p.state === 'finished').length;
            const isRaceOngoing = ponies.some(p => p.state === 'racing');
            
            // Trigger when ALL ponies have crossed the line
            let allFinishedTrigger = (totalPonies > 0 && finishedPonies === totalPonies);

            // Spawn Grass
            if (!isRaceOngoing && totalPonies > 0 && grass.length < 8 && Math.random() < 0.01) {
                grass.push({
                    id: Math.random(),
                    x: 20 + Math.random() * (SCREEN_WIDTH - 40),
                    y: 40 + Math.random() * (SCREEN_HEIGHT - 60)
                });
            }

            // Winner Logic
            let winnerFoundThisFrame = false;
            const existingWinner = ponies.some(p => p.hasCrown);

            ponies.forEach(p => {
                // RESET TO ROAMING
                if (allFinishedTrigger && p.state === 'finished') {
                    p.state = 'roaming';
                    p.timer = 0;
                    p.targetX = null;
                    
                    // Omni-directional Spawn
                    const side = Math.floor(Math.random() * 4); 
                    const SAFE_TOP = 35; 
                    const SAFE_H = SCREEN_HEIGHT - PONY_HEIGHT - 10 - SAFE_TOP;
                    
                    if (side === 0) { p.x = 20 + Math.random() * 900; p.y = -50; } // Top
                    else if (side === 1) { p.x = SCREEN_WIDTH + 10; p.y = SAFE_TOP + Math.random() * SAFE_H; } // Right
                    else if (side === 2) { p.x = 20 + Math.random() * 900; p.y = SCREEN_HEIGHT + 10; } // Bottom
                    else { p.x = -50; p.y = SAFE_TOP + Math.random() * SAFE_H; } // Left
                }

                // STATE: RACING
                if (p.state === 'racing') {
                    let variance = 0.5 + Math.random() * 1.5;
                    p.x += p.speed * variance;
                    p.facing = 'right';

                    // Finish Line (Off screen right)
                    if (p.x > SCREEN_WIDTH + 20) {
                        p.state = 'finished';
                        // Award Crown
                        if (!existingWinner && !winnerFoundThisFrame) {
                            p.hasCrown = true;
                            winnerFoundThisFrame = true;
                        }
                    }
                } 
                // STATE: FINISHED
                else if (p.state === 'finished') {
                    p.x += 0.1; 
                }
                // STATE: ROAMING
                else if (p.state === 'roaming') {
                    // Check for grass
                    let closest = null; 
                    let minDist = 150;
                    grass.forEach(g => {
                        const d = Math.sqrt(Math.pow(g.x - p.x, 2) + Math.pow(g.y - p.y, 2));
                        if(d < minDist) { minDist = d; closest = g; }
                    });

                    if (closest) {
                        p.state = 'walking_to_food';
                    } else {
                        handleRoamingMovement(p);
                    }
                }
                // STATE: WALKING TO FOOD
                else if (p.state === 'walking_to_food') {
                    // Re-find closest grass (it might be gone)
                    let closest = null; 
                    let d = 9999;
                    grass.forEach(item => {
                        let dist = Math.sqrt(Math.pow(item.x - p.x, 2) + Math.pow(item.y - p.y, 2));
                        if(dist < d) { d = dist; closest = item; }
                    });

                    if (!closest) {
                        p.state = 'roaming';
                    } else {
                        const dx = closest.x - p.x;
                        const dy = closest.y - p.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        if (dist < 5) {
                            p.state = 'eating';
                            p.timer = 100;
                            grass = grass.filter(item => item !== closest); // Eat it
                        } else {
                            p.x += (dx/dist) * 1.0;
                            p.y += (dy/dist) * 1.0;
                            p.facing = dx > 0 ? 'right' : 'left';
                        }
                    }
                }
                // STATE: EATING
                else if (p.state === 'eating') {
                    if (p.timer > 0) p.timer--;
                    else p.state = 'roaming';
                }
            });

            // Cleanup (>10)
            if (!isRaceOngoing && ponies.length > 10) {
                const winner = ponies.find(p => p.hasCrown);
                const others = ponies.filter(p => !p.hasCrown);
                const keepCount = winner ? 9 : 10;
                const keptOthers = others.slice(-keepCount);
                ponies = winner ? [...keptOthers, winner] : keptOthers;
            }
        }

        function handleRoamingMovement(p) {
            // Bounds check
            if (p.x < -50 || p.x > SCREEN_WIDTH || p.y < -50 || p.y > SCREEN_HEIGHT) {
                const dx = (SCREEN_WIDTH/2) - p.x;
                const dy = (SCREEN_HEIGHT/2) - p.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                p.x += (dx/len) * 1.5;
                p.y += (dy/len) * 1.5;
                p.facing = dx > 0 ? 'right' : 'left';
                return;
            }

            if (p.timer > 0) {
                p.timer--;
            } else {
                if (Math.random() > 0.3) {
                    p.targetX = Math.random() * (SCREEN_WIDTH - 40);
                    p.timer = 60 + Math.random() * 100;
                } else {
                    p.state = 'eating';
                    p.timer = 60;
                }
            }

            if (p.targetX !== undefined && p.targetX !== null) {
                const dist = p.targetX - p.x;
                if (Math.abs(dist) > 2) {
                    p.x += Math.sign(dist) * 0.5;
                    p.facing = dist > 0 ? 'right' : 'left';
                } else {
                    p.targetX = null;
                }
            }

            if (Math.random() < 0.05) {
                p.y += (Math.random() - 0.5) * 2;
                if (p.y < 35) p.y = 35;
                if (p.y > SCREEN_HEIGHT - 40) p.y = SCREEN_HEIGHT - 40;
            }
        }

        // --- RENDERER ---
        function render() {
            const ponyLayer = document.getElementById('pony-layer');
            const grassLayer = document.getElementById('grass-layer');
            
            // Render Grass
            grassLayer.innerHTML = '';
            grass.forEach(g => {
                const el = document.createElement('div');
                el.className = 'grass';
                el.style.transform = `translate3d(${g.x}px, ${g.y}px, 0)`;
                grassLayer.appendChild(el);
            });

            // Render Ponies (Diff)
            const existingNodes = Array.from(ponyLayer.children);
            const activeIds = new Set(ponies.map(p => p.id));

            existingNodes.forEach(node => {
                if (!activeIds.has(node.id)) node.remove();
            });

            ponies.forEach(p => {
                let el = document.getElementById(p.id);
                if (!el) {
                    el = createPonyDOM(p);
                    ponyLayer.appendChild(el);
                }
                
                el.style.transform = `translate3d(${p.x}px, ${p.y}px, 0)`;
                el.style.zIndex = Math.floor(p.y);

                const pixelContainer = el.querySelector('.pixel-grid-container');
                pixelContainer.style.transform = p.facing === 'left' ? 'scaleX(-1)' : 'scaleX(1)';

                // Crown Logic
                const crownEl = el.querySelector('.crown');
                if (p.hasCrown) {
                    crownEl.classList.remove('hidden');
                } else {
                    crownEl.classList.add('hidden');
                }

                const nameEl = el.querySelector('.name-tag');
                nameEl.style.color = p.hasCrown ? '#facc15' : p.color;
                nameEl.style.opacity = p.hasCrown ? 1 : 0.8;

                updatePonyAnimation(p, el);
            });
        }

        function createPonyDOM(p) {
            const div = document.createElement('div');
            div.id = p.id;
            div.className = 'entity';
            div.style.width = PONY_WIDTH + 'px';
            div.style.height = PONY_HEIGHT + 'px';

            const crown = document.createElement('div');
            crown.className = 'crown hidden';
            crown.innerText = 'ðŸ‘‘';
            div.appendChild(crown);

            const name = document.createElement('div');
            name.className = 'name-tag vfd-glow';
            name.innerText = p.name;
            div.appendChild(name);

            const gridContainer = document.createElement('div');
            gridContainer.className = 'pixel-grid-container';
            const grid = document.createElement('div');
            grid.className = 'pixel-grid';
            gridContainer.appendChild(grid);
            div.appendChild(gridContainer);

            return div;
        }

        function updatePonyAnimation(p, el) {
            const gridEl = el.querySelector('.pixel-grid');
            if (!p.frameTimer) p.frameTimer = 0;
            if (!p.currentFrame) p.currentFrame = 0;

            const isMoving = p.state !== 'idle' && p.state !== 'finished';
            
            if (isMoving) {
                p.frameTimer++;
                if (p.frameTimer > 10) {
                    p.currentFrame = (p.currentFrame + 1) % 2;
                    p.frameTimer = 0;
                    renderPixels(gridEl, p);
                }
            } else {
                if (p.currentFrame !== 0) {
                    p.currentFrame = 0;
                    renderPixels(gridEl, p);
                }
            }
            if (gridEl.children.length === 0) {
                renderPixels(gridEl, p);
            }
        }

        function renderPixels(gridEl, p) {
            const frame1 = p.pixels;
            // Auto-animate logic (8 rows)
            let frame2 = frame1.map((row, y) => {
                if (y < 6) { 
                    return y > 0 ? frame1[y-1] : [0,0,0,0,0,0,0,0];
                } else { 
                    let newRow = [...row];
                    for(let i=0; i<8; i++) {
                        newRow[i] = row[(i+3)%8];
                    }
                    return newRow;
                }
            });
            if (p.state === 'eating') {
               frame2 = frame1.map((row, y) => {
                   if (y >= 1 && y <= 4) return frame1[y-1];
                   if (y===0) return [0,0,0,0,0,0,0,0];
                   return row;
               });
            }

            const currentData = p.currentFrame === 0 ? frame1 : frame2;
            
            let html = '';
            for(let y=0; y<8; y++) {
                for(let x=0; x<8; x++) {
                    if (currentData[y][x]) {
                        html += `<div class="pixel" style="background-color: ${p.color}; box-shadow: 0 0 4px ${p.color}; grid-column: ${x+1}; grid-row: ${y+1};"></div>`;
                    }
                }
            }
            gridEl.innerHTML = html;
        }

        // --- ACTIONS ---
        function createPony(name, pixels, color) {
            const id = 'p-' + Date.now() + '-' + Math.random();
            
            // Limit 10 (keep newest)
            if (ponies.length >= 10) {
                // Keep winner + 9
                const winnerIdx = ponies.findIndex(p => p.hasCrown);
                if (winnerIdx !== -1) {
                    const nonWinners = ponies.filter(p => !p.hasCrown);
                    // Keep last 8 non-winners + winner
                    const kept = nonWinners.slice(-8);
                    ponies = [...kept, ponies[winnerIdx]];
                } else {
                    ponies = ponies.slice(-9);
                }
            }

            // RESET
            ponies.forEach(p => {
                p.state = 'racing';
                p.x = 20;
                p.y = 20 + Math.random() * (SCREEN_HEIGHT - PONY_HEIGHT - 40);
                p.speed = 1.5 + Math.random() * 2.0; 
                p.hasCrown = false;
                p.targetX = null;
            });

            // ADD NEW
            const newPony = {
                id,
                name: name || getRandomName(),
                x: 20,
                y: 20 + Math.random() * (SCREEN_HEIGHT - PONY_HEIGHT - 40),
                facing: 'right',
                state: 'racing',
                speed: 1.5 + Math.random() * 2.0,
                hasCrown: false,
                color: color || COLORS.TURQUOISE,
                pixels: pixels || DEFAULT_FRAME_1,
                timer: 0
            };
            ponies.push(newPony);
            grass = []; // Clear grass for race
        }

        function savePony() {
            const name = document.getElementById('editor-name').value;
            createPony(name, editorGrid, selectedColor);
            closeEditor();
        }

        // --- UI UTILS ---
        function getRandomName() {
            const names = ["PIXEL", "VFD", "GLOW", "NEON", "BIT", "BYTE", "ECHO", "FLUX", "SYNC", "WAVE", "DATA", "ZAP"];
            return names[Math.floor(Math.random() * names.length)];
        }

        function openEditor() {
            document.getElementById('modal-editor').classList.remove('hidden');
        }
        function closeEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
        }
        function clearEditor() {
            editorGrid = Array(8).fill(0).map(() => Array(8).fill(0));
            renderEditorGrid('desktop-editor-grid');
        }

        function buildColorPicker(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            Object.values(COLORS).forEach(c => {
                const div = document.createElement('div');
                div.className = 'color-dot';
                div.style.backgroundColor = c;
                div.style.boxShadow = `0 0 5px ${c}`;
                if (c === selectedColor) div.classList.add('selected');
                div.onclick = () => {
                    selectedColor = c;
                    document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    if (containerId === 'desktop-color-picker') renderEditorGrid('desktop-editor-grid');
                    else renderEditorGrid('mobile-editor-grid');
                };
                container.appendChild(div);
            });
        }

        function buildEditorGrid(containerId) {
            renderEditorGrid(containerId);
        }

        function renderEditorGrid(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            editorGrid.forEach((row, r) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'editor-row';
                row.forEach((val, c) => {
                    const cell = document.createElement('div');
                    cell.className = 'editor-cell';
                    if (val) {
                        cell.classList.add('active');
                        cell.style.backgroundColor = selectedColor;
                        cell.style.boxShadow = `0 0 4px ${selectedColor}`;
                    }
                    cell.onmousedown = () => togglePixel(r, c, containerId);
                    cell.onmouseenter = (e) => { if(e.buttons === 1) togglePixel(r, c, containerId, true); }
                    rowDiv.appendChild(cell);
                });
                container.appendChild(rowDiv);
            });
        }

        function togglePixel(r, c, containerId, isDrag) {
            if (isDrag) {
                editorGrid[r][c] = 1;
            } else {
                editorGrid[r][c] = editorGrid[r][c] ? 0 : 1;
            }
            renderEditorGrid(containerId);
        }

        // --- MOBILE ---
        function initMobile(hostId) {
            buildColorPicker('mobile-color-picker');
            const container = document.getElementById('mobile-editor-container');
            container.innerHTML = '<div id="mobile-editor-grid" class="editor-grid"></div>';
            renderEditorGrid('mobile-editor-grid');

            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);
                conn.on('open', () => {
                    document.getElementById('mobile-status').innerText = "CONNECTED";
                    document.getElementById('mobile-status').style.background = "#004d40";
                });
                conn.on('error', () => {
                    document.getElementById('mobile-status').innerText = "ERROR";
                    document.getElementById('mobile-status').style.background = "red";
                });
            });
        }

        function sendPonyFromMobile() {
            if (!conn) return;
            const name = document.getElementById('mobile-name-input').value || "MOBILE";
            conn.send({
                name: name,
                pixels: editorGrid,
                color: selectedColor
            });
            alert("Sent!");
        }

        init();
    </script>
</body>
</html>
