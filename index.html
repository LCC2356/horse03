<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NOWHERE TO RUN</title>

  <!-- PeerJS + QR -->
  <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#0a0a0a;
      --primary:#fff;
      --panel:#222;
      --border:#444;
      --accent:#40e0d0;

      /* Track size (length adjustable; height fixed) */
      --game-w: 3400px;
      --game-h: 100px;

      /* Track border controls */
      --track-border-on: 1;     /* 1 or 0 */
      --track-border-w: 2px;    /* px */
    }

    *{ box-sizing:border-box; user-select:none; -webkit-user-select:none; }
    body{
      margin:0; background:var(--bg); color:var(--primary);
      font-family:'VT323', monospace;
      height:100vh; width:100vw; overflow:hidden;
    }
    .hidden{ display:none !important; }

    /* ===================== DESKTOP ===================== */
    #desktop-view{
      position:absolute; inset:0; background:#000;
      overflow:hidden;
    }
    #game-container{
      position:absolute; left:50%; top:50%;
      width:0; height:0;
      display:flex; justify-content:center; align-items:center;
    }

    /* New: outer wrapper for zoom + x/y; inner wrapper for stretch */
    #layout-wrapper{
      position:relative;
      transform-origin:center;
      will-change: transform;
    }
    #track-wrapper{
      display:flex;
      width: calc(var(--game-w) + var(--game-h));
      height: var(--game-h);
      flex-shrink:0;
      position:relative;
      transform-origin:center;
      will-change: transform;
    }

    #game-screen{
      width: var(--game-w);
      height: var(--game-h);
      background:#000;
      position:relative;
      overflow:hidden;
      flex-shrink:0;

      border-style:solid;
      border-color:var(--primary);
      border-width: calc(var(--track-border-on) * var(--track-border-w));
      border-right-width:0;
    }
    #side-qr-box{
      width: var(--game-h);
      height: var(--game-h);
      background:#000;
      display:flex; align-items:center; justify-content:center;
      position:relative; flex-shrink:0;

      border-style:solid;
      border-color:var(--primary);
      border-width: calc(var(--track-border-on) * var(--track-border-w));
    }
    .join-label{
      position:absolute; bottom:2px; left:0; width:100%;
      text-align:center; font-size:14px; color:#777;
      text-shadow:1px 1px 0 #000;
      pointer-events:none;
    }
    #qrcode{ background:#fff; padding:3px; width:86px; height:86px; border-radius:2px; }
    #qrcode img{ width:100%; height:100%; display:block; }

    .grid-bg{
      position:absolute; inset:0; opacity:0.18; pointer-events:none;
      background-image:
        linear-gradient(rgba(255,255,255,0.25) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.25) 1px, transparent 1px);
      background-size:50px 50px;
    }

    .finish-line{
      position:absolute; top:0; bottom:0;
      left: calc(var(--game-w) - 400px);
      width:12px;
      background-image: linear-gradient(45deg,#fff 25%,transparent 25%,transparent 50%,#fff 50%,#fff 75%,transparent 75%,transparent);
      background-size:12px 12px;
      opacity:0.8;
      z-index:2;
      pointer-events:none;
    }

    #layer-snow{ position:absolute; inset:0; z-index:1; pointer-events:none; }
    #layer-grass{ position:absolute; inset:0; z-index:2; pointer-events:none; }
    #layer-pony{ position:absolute; inset:0; z-index:5; pointer-events:none; }
    #layer-fx{ position:absolute; inset:0; z-index:10; pointer-events:none; }

    .snowflake{
      position:absolute; top:-10px;
      background:#fff; border-radius:50%;
      box-shadow:0 0 4px #fff;
      animation-name:snowfall;
      animation-timing-function:linear;
      animation-fill-mode:forwards;
    }
    @keyframes snowfall{
      to{ transform:translateY(calc(var(--game-h) + 20px)); opacity:0.2; }
    }
    .grass{
      position:absolute; width:6px; height:6px;
      background:#69f0ae; box-shadow:0 0 4px #69f0ae;
      opacity:0.8;
    }

    .entity{
      position:absolute;
      width:44px; height:44px;
      will-change:transform;
      pointer-events:none;
      z-index:6;
    }
    .pixel-grid{
      display:grid;
      grid-template-columns: repeat(11, 1fr);
      width:100%; height:100%;
      transform-origin:bottom center;
    }
    .name-tag{
      position:absolute;
      top:-18px; left:50%;
      transform:translateX(-50%);
      font-size:20px;
      color: var(--accent);
      text-shadow:1px 1px 0 #000;
      white-space:nowrap;
    }
    .crown-container{
      position:absolute;
      top:-30px; left:50%;
      transform:translateX(-50%);
      width:18px; height:18px;
      display:flex; align-items:flex-end; justify-content:center;
      animation:bounce 1s infinite;
    }
    @keyframes bounce{ 0%,100%{ transform:translateX(-50%) translateY(0);} 50%{ transform:translateX(-50%) translateY(-4px);} }
    .crown{
      width:0; height:0;
      border-left:9px solid transparent;
      border-right:9px solid transparent;
      border-bottom:14px solid #facc15;
      filter: drop-shadow(0 0 5px #facc15);
    }

    .shockwave{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:10px; height:10px;
      border-radius:50%;
      border:4px solid rgba(255,255,255,0.8);
      animation: shock-expand 0.4s ease-out forwards;
    }
    @keyframes shock-expand{
      0%{ width:10px; height:10px; opacity:1; }
      100%{ width:100px; height:100px; opacity:0; border-width:0; }
    }
    .tug-spark{
      position:absolute; width:4px; height:4px; border-radius:50%;
      background:#fff;
      box-shadow:0 0 10px #fff, 0 0 20px #ff00ff;
      opacity:0.95;
    }

    #hud{
      position:absolute; bottom:4px; right:10px;
      font-size:32px; opacity:0.6; letter-spacing:2px;
      z-index:50;
      pointer-events:none;
    }
    #queue-text{
      position:absolute; top:10px; right:20px;
      font-size:24px; color:#ffb300;
      text-shadow:0 0 5px #ffb300;
      z-index:60;
      display:none;
      pointer-events:none;
    }

    #track-display-bar{
      position:absolute; top:50%; left:0; width:100%;
      height:100px;
      transform:translateY(-50%);
      display:none;
      align-items:center; justify-content:center;
      z-index:80;
      pointer-events:none;
    }
    .bar-container{ width:100%; display:flex; justify-content:center; align-items:center; }
    .bar-text-item{
      font-size:80px;
      font-weight:bold;
      width:260px;
      display:flex; justify-content:center;
      text-shadow:0 0 20px currentColor;
      animation: text-pop 0.3s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
    }
    @keyframes text-pop{ 0%{ transform:scale(0.5); opacity:0;} 100%{ transform:scale(1); opacity:1;} }
    @keyframes text-vanish{ 0%{ opacity:1;} 100%{ opacity:0;} }

    /* Tug layer */
    #tug-layer{ position:absolute; inset:0; z-index:3; display:none; pointer-events:none; }
    #tug-blue-zone{
      position:absolute; left:0; top:0; bottom:0;
      width:50%;
      background:#001133;
      box-shadow: inset 0 0 80px #2979ff;
      border-right:6px solid #fff;
      filter: drop-shadow(0 0 10px #fff);
      transition: width 0.08s linear;
    }
    #tug-red-zone{
      position:absolute; right:0; top:0; bottom:0;
      width:50%;
      background:#330000;
      box-shadow: inset 0 0 80px #ff0000;
      transition: width 0.08s linear;
    }
    .icon-vs{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      font-size:60px;
      color:#fff;
      text-shadow:0 0 20px #fff, 0 0 40px #ff00ff;
      opacity:0.95;
    }

    /* Desktop control panel */
    #bottom-controls{
      position:fixed; left:20px; bottom:20px;
      display:flex; align-items:center; gap:15px;
      padding:15px;
      background:rgba(0,0,0,0.85);
      border:1px solid var(--border);
      border-radius:8px;
      z-index:1000;
      box-shadow:0 0 20px rgba(0,0,0,0.8);
      flex-wrap:wrap;
    }
    .control-group{
      display:flex; flex-direction:column; gap:5px;
      border-left:1px solid #333;
      padding-left:15px;
      width:140px;
    }
    .control-group:first-child{ border-left:none; padding-left:0; }
    .control-label{ font-size:0.8rem; color:#888; letter-spacing:1px; }
    .input-wrapper{ display:flex; gap:8px; align-items:center; }
    .unit-label{ font-size:1.2rem; color:#555; }

    input[type=range]{ -webkit-appearance:none; width:100%; background:transparent; margin:5px 0; }
    input[type=range]::-webkit-slider-runnable-track{
      width:100%; height:6px; background:#333; border-radius:3px; border:1px solid #555;
    }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px; height:16px; border-radius:2px;
      background:var(--accent); margin-top:-6px;
      box-shadow:0 0 5px var(--accent);
    }
    input[type="number"], input[type="text"]{
      background:#222; border:1px solid var(--border); color:var(--primary);
      font-family:'VT323', monospace;
      font-size:1.4rem;
      padding:2px 6px;
      border-radius:4px;
      text-align:center;
    }
    input[type="number"]{ width:80px; }
    input[type="checkbox"]{ width:18px; height:18px; accent-color:var(--accent); }

    select{
      background:#222; border:2px solid var(--border); color:#fff;
      padding:8px;
      font-family:'VT323', monospace;
      font-size:1.2rem;
      cursor:pointer;
    }

    .btn{
      background:#222; border:2px solid var(--primary); color:var(--primary);
      padding:10px 18px;
      font-family:'VT323', monospace;
      font-size:1.2rem;
      cursor:pointer;
      text-transform:uppercase;
      box-shadow:0 0 20px rgba(255,255,255,0.2);
      transition: all 0.15s;
    }
    .btn:hover{ background:#fff; color:#000; }
    .btn:active{ transform: translateY(2px); }

    /* ===================== MOBILE ===================== */
    #mobile-view{
      position:fixed; inset:0;
      background:#111;
      display:none;
      flex-direction:column;
      z-index:20000;
      padding:20px;
      align-items:center;
    }
    .m-header{
      width:100%; max-width:400px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #333;
      padding-bottom:15px;
      margin-bottom:20px;
    }
    .m-title{ font-size:1.5rem; }
    .m-status{
      background:#222; border:1px solid #444;
      padding:4px 8px; border-radius:4px;
      font-size:1rem;
    }
    .m-controls{
      width:100%; max-width:400px;
      display:flex; flex-direction:column; gap:15px;
      margin-bottom:15px;
    }
    .m-canvas-container{
      flex:1;
      width:100%; max-width:400px;
      background:#1a1a1a;
      border-radius:8px;
      margin-bottom:20px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .m-footer{
      width:100%; max-width:400px;
      display:flex; gap:15px;
      height:60px;
    }
    .btn-flex{ flex:1; display:flex; align-items:center; justify-content:center; }

    .editor-grid{
      display:grid;
      grid-template-columns: repeat(11, 1fr);
      grid-template-rows: repeat(11, 1fr);
      gap:2px;
      background:#333;
      border:2px solid #555;
      touch-action:none;
    }
    .editor-cell{ width:28px; height:28px; background:#000; }
    .color-picker{
      display:flex; justify-content:center; gap:12px;
      flex-wrap:wrap;
    }
    .c-dot{
      width:34px; height:34px;
      border-radius:50%;
      border:2px solid #333;
      cursor:pointer;
    }
    .c-dot.active{ border-color:#fff; transform:scale(1.1); }

    /* Mobile controller */
    #m-controller{
      position:fixed; inset:0;
      background:#111;
      z-index:22000;
      display:none;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    #m-info{
      font-size:1.5rem; color:#888;
      margin-bottom:24px;
      text-align:center;
    }
    .push-btn{
      width:250px; height:250px;
      border-radius:50%;
      background:#222;
      border:8px solid #444;
      color:#888;
      font-size:3.6rem;
      font-family:'VT323', monospace;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      line-height:1;
      padding:18px;
      box-shadow:0 0 50px rgba(0,0,0,0.45);
      touch-action:none;
      -webkit-tap-highlight-color:transparent;
    }
    .push-btn:active{ transform:scale(0.96); }
    .btn-wait{ background:#1a1a1a !important; border-color:#333 !important; color:#555 !important; }
    .btn-mash{ background:#fff !important; border-color:#ccc !important; color:#000 !important; box-shadow:0 0 60px rgba(255,255,255,0.6) !important; }
    .btn-start{ background:#fff !important; border-color:#ccc !important; color:#000 !important; }
    .btn-team-red{ background:#ff0000 !important; border-color:#ff5252 !important; color:#fff !important; }
    .btn-team-blue{ background:#0044ff !important; border-color:#40e0d0 !important; color:#fff !important; }

    /* Hidden mobile admin panel */
    #m-admin{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.92);
      z-index:25000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .m-admin-card{
      width:100%; max-width:420px;
      background:#141414;
      border:2px solid #fff;
      border-radius:10px;
      padding:18px;
      box-shadow:0 0 40px rgba(255,255,255,0.12);
    }
    .m-admin-title{
      font-size:1.8rem;
      margin-bottom:10px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .m-admin-hint{
      font-size:1rem; color:#888;
      margin-bottom:14px;
    }
    .m-admin-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 0;
      border-top:1px solid #2b2b2b;
    }
    .m-admin-row:first-of-type{ border-top:none; }
    .m-admin-label{ font-size:1.2rem; color:#ddd; min-width:90px; }
    .m-admin-control{ display:flex; align-items:center; gap:10px; width:100%; justify-content:flex-end; }
    .m-admin-control input[type="number"]{ width:140px; font-size:1.4rem; padding:6px 8px; border-radius:6px; }
    .m-admin-control select{ width:200px; font-size:1.3rem; border-radius:6px; }
    .m-admin-actions{ display:flex; gap:12px; margin-top:14px; }
    .m-btn-small{
      flex:1;
      padding:12px 10px;
      font-size:1.2rem;
      border-radius:8px;
      border:2px solid #fff;
      background:#222; color:#fff;
      font-family:'VT323', monospace;
      text-transform:uppercase;
    }
    .m-btn-small.primary{ background:#fff; color:#000; }
    .m-btn-small.danger{ border-color:#ff5252; color:#ff5252; }
  </style>
</head>

<body>
  <!-- ===================== DESKTOP VIEW (Host) ===================== -->
  <div id="desktop-view">
    <div id="game-container">
      <div id="layout-wrapper">
        <div id="track-wrapper">
          <div id="game-screen">
            <div class="grid-bg"></div>

            <div id="tug-layer">
              <div id="tug-red-zone"></div>
              <div id="tug-blue-zone"></div>
              <div class="icon-vs">VS</div>
            </div>

            <div class="finish-line"></div>

            <div id="hud">NOWHERE TO RUN</div>
            <div id="queue-text"></div>

            <div id="track-display-bar">
              <div class="bar-container" id="bar-text"></div>
            </div>

            <div id="layer-snow"></div>
            <div id="layer-grass"></div>
            <div id="layer-pony"></div>
            <div id="layer-fx"></div>
          </div>

          <div id="side-qr-box">
            <div id="qrcode"></div>
            <div class="join-label">JOIN</div>
          </div>
        </div>
      </div>
    </div>

    <div id="bottom-controls">
      <div class="control-group">
        <span class="control-label">ZOOM</span>
        <input type="range" id="zoom-slider" min="1" max="500" step="0.1" value="100" />
        <div class="input-wrapper">
          <input type="number" id="zoom-input" value="100" min="1" max="500" step="0.1" inputmode="decimal" />
          <span class="unit-label">%</span>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">STRETCH</span>
        <input type="range" id="stretch-slider" min="50" max="200" step="1" value="100" />
        <div class="input-wrapper">
          <input type="number" id="stretch-input" value="100" min="50" max="200" step="1" inputmode="numeric" />
          <span class="unit-label">%</span>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">X OFFSET</span>
        <input type="range" id="x-slider" min="-3000" max="3000" step="1" value="0" />
        <div class="input-wrapper">
          <input type="number" id="x-input" value="0" step="0.1" inputmode="decimal" />
          <span class="unit-label">PX</span>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">Y OFFSET</span>
        <input type="range" id="y-slider" min="-1200" max="1200" step="1" value="0" />
        <div class="input-wrapper">
          <input type="number" id="y-input" value="0" step="0.1" inputmode="decimal" />
          <span class="unit-label">PX</span>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">LENGTH</span>
        <div class="input-wrapper">
          <input type="number" id="len-input" value="3400" min="800" max="12000" step="10" inputmode="numeric" />
          <span class="unit-label">PX</span>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">GAME MODE</span>
        <select id="mode-select">
          <option value="RANDOM">RANDOM</option>
          <option value="CLASSIC">RUN</option>
          <option value="HURDLE">JUMP</option>
          <option value="RED_LIGHT">STOP?</option>
          <option value="TUG">TEAM</option>
        </select>
      </div>

      <div class="control-group">
        <span class="control-label">SNOW</span>
        <div class="input-wrapper">
          <input type="checkbox" id="snow-toggle" checked />
          <span class="unit-label" id="snow-toggle-label">ON</span>
        </div>
      </div>

      <div class="control-group">
        <span class="control-label">BORDER</span>
        <div class="input-wrapper">
          <input type="checkbox" id="border-toggle" checked />
          <span class="unit-label" id="border-toggle-label">ON</span>
        </div>
        <div class="input-wrapper">
          <input type="number" id="border-width-input" value="2" min="0" max="20" step="0.5" inputmode="decimal" />
          <span class="unit-label">PX</span>
        </div>
      </div>

      <button class="btn" id="btn-addbot">+ BOT</button>
      <button class="btn" id="btn-start">START</button>
    </div>
  </div>

  <!-- ===================== MOBILE VIEW (Join) ===================== -->
  <div id="mobile-view">
    <div id="m-editor-ui">
      <div class="m-header">
        <span class="m-title" id="m-title">NOWHERE TO RUN</span>
        <span class="m-status" id="m-status">Connecting...</span>
      </div>

      <div class="m-controls">
        <input type="text" id="m-name" placeholder="ENTER NAME" maxlength="8" />
        <div class="color-picker" id="m-colors"></div>
      </div>

      <div class="m-canvas-container">
        <div id="m-grid" class="editor-grid"></div>
      </div>

      <div class="m-footer">
        <button class="btn btn-flex" id="m-clear">CLEAR</button>
        <button class="btn btn-flex" id="m-send">RUN</button>
      </div>
    </div>

    <div id="m-controller">
      <div id="m-info">WAIT</div>
      <div id="m-btn" class="push-btn btn-wait">WAIT</div>
    </div>

    <div id="m-admin">
      <div class="m-admin-card">
        <div class="m-admin-title">
          <span>HOST CONTROL</span>
          <span style="font-size:1rem; color:#888;">(hidden)</span>
        </div>
        <div class="m-admin-hint">Tap title 5x on create screen to open. Zoom/X/Y accept decimals.</div>

        <div class="m-admin-row">
          <div class="m-admin-label">ZOOM</div>
          <div class="m-admin-control">
            <input type="number" id="m-admin-zoom" min="1" max="500" step="0.1" value="100" inputmode="decimal" />
            <span class="unit-label">%</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">STRETCH</div>
          <div class="m-admin-control">
            <input type="number" id="m-admin-stretch" min="50" max="200" step="1" value="100" inputmode="numeric" />
            <span class="unit-label">%</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">X OFFSET</div>
          <div class="m-admin-control">
            <input type="number" id="m-admin-x" min="-3000" max="3000" step="0.1" value="0" inputmode="decimal" />
            <span class="unit-label">PX</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">Y OFFSET</div>
          <div class="m-admin-control">
            <input type="number" id="m-admin-y" min="-1200" max="1200" step="0.1" value="0" inputmode="decimal" />
            <span class="unit-label">PX</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">LENGTH</div>
          <div class="m-admin-control">
            <input type="number" id="m-admin-len" min="800" max="12000" step="10" value="3400" inputmode="numeric" />
            <span class="unit-label">PX</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">MODE</div>
          <div class="m-admin-control">
            <select id="m-admin-mode">
              <option value="RANDOM">RANDOM</option>
              <option value="CLASSIC">RUN</option>
              <option value="HURDLE">JUMP</option>
              <option value="RED_LIGHT">STOP?</option>
              <option value="TUG">TEAM</option>
            </select>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">SNOW</div>
          <div class="m-admin-control">
            <input type="checkbox" id="m-admin-snow" checked />
            <span class="unit-label" id="m-admin-snow-label">ON</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">BORDER</div>
          <div class="m-admin-control">
            <input type="checkbox" id="m-admin-border" checked />
            <span class="unit-label" id="m-admin-border-label">ON</span>
          </div>
        </div>

        <div class="m-admin-row">
          <div class="m-admin-label">B WIDTH</div>
          <div class="m-admin-control">
            <input type="number" id="m-admin-borderw" min="0" max="20" step="0.5" value="2" inputmode="decimal" />
            <span class="unit-label">PX</span>
          </div>
        </div>

        <div class="m-admin-actions">
          <button class="m-btn-small primary" id="m-admin-apply">APPLY</button>
          <button class="m-btn-small" id="m-admin-addbot">+ BOT</button>
          <button class="m-btn-small danger" id="m-admin-back">BACK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       Core settings / constants
    ========================================================= */
    let gameW = 3400;
    const GAME_H = 100;
    const PONY_SIZE = 44;

    const COLORS = {
      CYAN:'#40e0d0',
      YELLOW:'#ffb300',
      RED:'#ff5252',
      GREEN:'#69f0ae',
      PURPLE:'#e040fb',
      WHITE:'#ffffff',
      BLUE:'#2979ff',
      ORANGE:'#ff8a65'
    };

    const DEFAULT_PIXELS = [
      [0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,1,0,0],
      [0,0,0,0,0,0,0,1,1,1,0],
      [0,0,0,0,0,0,0,1,1,1,1],
      [0,1,0,0,0,0,1,1,1,0,0],
      [1,0,1,1,1,1,1,1,1,0,0],
      [1,0,1,1,1,1,1,1,1,0,0],
      [0,0,1,1,1,1,1,1,1,0,0],
      [0,0,1,0,1,0,1,0,1,0,0],
      [0,0,1,0,1,0,1,0,1,0,0],
      [0,0,1,0,1,0,1,0,1,0,0]
    ];

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function rand(min,max){ return min + Math.random()*(max-min); }
    function getFinishX(){ return Math.max(200, gameW - 400); }

    /* =========================================================
       Layout controls (zoom / stretch / x / y)
       - Zoom + X/Y apply to #layout-wrapper
       - Stretch applies to #track-wrapper (visual stretch only)
    ========================================================= */
    let layout = {
      scale: 1.0,
      stretchX: 1.0,  // 1.0 = 100%
      x: 0,
      y: 0
    };

    function applyLayout(updateInputs=true){
      const outer = document.getElementById('layout-wrapper');
      const inner = document.getElementById('track-wrapper');

      if(outer){
        outer.style.transform = `scale(${layout.scale}) translate(${layout.x}px, ${layout.y}px)`;
      }
      if(inner){
        inner.style.transform = `scaleX(${layout.stretchX})`;
      }

      if(!updateInputs) return;

      const zoomPct = layout.scale * 100;
      const stretchPct = layout.stretchX * 100;

      const zi = document.getElementById('zoom-input');
      const zs = document.getElementById('zoom-slider');
      const si = document.getElementById('stretch-input');
      const ss = document.getElementById('stretch-slider');

      const xi = document.getElementById('x-input');
      const xs = document.getElementById('x-slider');
      const yi = document.getElementById('y-input');
      const ys = document.getElementById('y-slider');

      if(zi) zi.value = zoomPct.toFixed(1);
      if(zs) zs.value = zoomPct.toFixed(1);

      if(si) si.value = Math.round(stretchPct);
      if(ss) ss.value = Math.round(stretchPct);

      if(xi) xi.value = Number(layout.x).toFixed(1);
      if(xs) xs.value = Math.round(layout.x);

      if(yi) yi.value = Number(layout.y).toFixed(1);
      if(ys) ys.value = Math.round(layout.y);
    }

    function fitScreen(){
      const availableW = window.innerWidth * 0.95;
      const totalW = (gameW + GAME_H) * layout.stretchX;
      layout.scale = Math.min(availableW / totalW, 1);
      layout.x = 0; layout.y = 0;
      applyLayout(true);
    }

    /* =========================================================
       Host-controlled toggles: snow + border
    ========================================================= */
    let snowEnabled = true;
    let trackBorderEnabled = true;
    let trackBorderWidth = 2;

    function setTrackBorder(enabled, widthPx, updateUI=true){
      trackBorderEnabled = !!enabled;
      const w = parseFloat(widthPx);
      if(!isNaN(w)) trackBorderWidth = clamp(w, 0, 20);
      document.documentElement.style.setProperty('--track-border-on', trackBorderEnabled ? 1 : 0);
      document.documentElement.style.setProperty('--track-border-w', trackBorderWidth + 'px');
      if(updateUI) syncDesktopBorderUI();
    }

    function syncDesktopBorderUI(){
      const cb = document.getElementById('border-toggle');
      const lbl = document.getElementById('border-toggle-label');
      const w = document.getElementById('border-width-input');
      if(cb) cb.checked = !!trackBorderEnabled;
      if(lbl) lbl.textContent = trackBorderEnabled ? 'ON' : 'OFF';
      if(w) w.value = String(trackBorderWidth);
    }

    function syncDesktopSnowUI(){
      const cb = document.getElementById('snow-toggle');
      const lbl = document.getElementById('snow-toggle-label');
      if(cb) cb.checked = !!snowEnabled;
      if(lbl) lbl.textContent = snowEnabled ? 'ON' : 'OFF';
      if(!snowEnabled){
        const layer = document.getElementById('layer-snow');
        if(layer) layer.innerHTML = '';
      }
    }

    /* =========================================================
       Track length - FIX: length change never alters layout.x
    ========================================================= */
    function setTrackLength(px, updateUI=true){
      const w = parseFloat(px);
      if(isNaN(w)) return;
      gameW = clamp(w, 800, 12000);
      document.documentElement.style.setProperty('--game-w', gameW + 'px');

      const maxX = gameW - PONY_SIZE - 6;
      ponies.forEach(p => p.x = clamp(p.x, 0, maxX));
      ponyQueue.forEach(p => p.x = clamp(p.x, 0, maxX));

      if(updateUI){
        const len = document.getElementById('len-input');
        if(len) len.value = String(Math.round(gameW));
      }

      applyLayout(false);
    }

    /* =========================================================
       PeerJS (Host + Client)
    ========================================================= */
    const PEER_CONFIG = {
      debug: 2,
      config: { iceServers: [ { url:'stun:stun.l.google.com:19302' }, { url:'stun:stun1.l.google.com:19302' } ] }
    };

    let peer = null;       // host peer (desktop)
    let conn = null;       // mobile connection to host
    let hostId = null;

    function broadcast(data){
      if(!peer || !peer.connections) return;
      Object.values(peer.connections).forEach(arr => arr.forEach(c => { if(c.open) c.send(data); }));
    }

    /* =========================================================
       Game state
    ========================================================= */
    let gameState = 'ROAMING';        // ROAMING, COOLDOWN, RACING, FINISHED, WAITING_TO_START
    let cooldownTimer = 0;
    let waitTimer = 0;

    let currentGameMode = 'CLASSIC';  // CLASSIC, HURDLE, RED_LIGHT, TUG
    let lightState = 'GREEN';
    let redLightTimer = 0;

    let tugValue = 50;

    let ponies = [];
    let ponyQueue = [];
    let grass = [];
    let obstacles = [];

    /* Swipe jump disabled by default */
    let swipeJumpEnabled = false;

    /* =========================================================
       UI bar text helpers
    ========================================================= */
    let currentBarText = '';
    let lastBroadcastText = '';

    function updateBarText(text, color){
      if(currentBarText === text) return;
      currentBarText = text;
      const container = document.getElementById('bar-text');
      let content = '';
      for(let i=0;i<12;i++) content += `<span class="bar-text-item">${text}</span>`;
      container.innerHTML = content;
      container.style.color = color || '#fff';
    }
    function setBarVisibility(show){
      const el = document.getElementById('track-display-bar');
      el.style.display = show ? 'flex' : 'none';
      if(!show) currentBarText = '';
    }

    /* =========================================================
       Effects: snow + grass + sparks + explosion
    ========================================================= */
    function spawnSnow(){
      if(!snowEnabled) return;
      const layer = document.getElementById('layer-snow');
      if(!layer) return;
      if(layer.children.length > 160) return;

      if(Math.random() < 0.55){
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        const s = rand(2,6);
        flake.style.width = s + 'px';
        flake.style.height = s + 'px';
        flake.style.left = rand(0, gameW) + 'px';
        flake.style.opacity = rand(0.3, 1.0);
        const dur = rand(1.2, 3.0);
        flake.style.animationDuration = dur + 's';
        layer.appendChild(flake);
        flake.addEventListener('animationend', ()=> flake.remove());
      }
    }

    function spawnGrassIfNeeded(){
      if(grass.length > 240) return;
      if(Math.random() < 0.06){
        grass.push({ x: rand(0, gameW), y: rand(10, GAME_H-10) });
      }
    }

    function spawnBattleSparks(x){
      const fx = document.getElementById('layer-fx');
      if(!fx) return;
      const count = Math.random() < 0.5 ? 1 : 2;
      for(let i=0;i<count;i++){
        const el = document.createElement('div');
        el.className = 'tug-spark';
        el.style.left = x + 'px';
        el.style.top = rand(0, GAME_H) + 'px';
        fx.appendChild(el);

        let vx = rand(-10, 10);
        let vy = rand(-8, 8);
        let life = 26;

        const tick = () => {
          life--;
          if(life<=0){ el.remove(); return; }
          el.style.left = (parseFloat(el.style.left) + vx) + 'px';
          el.style.top  = (parseFloat(el.style.top)  + vy) + 'px';
          el.style.opacity = (life/26).toFixed(2);
          vy += 0.35;
          requestAnimationFrame(tick);
        };
        tick();
      }
    }

    function explode(pony){
      const fx = document.getElementById('layer-fx');
      if(!fx) return;

      const shock = document.createElement('div');
      shock.className = 'shockwave';
      shock.style.left = (pony.x + PONY_SIZE/2) + 'px';
      shock.style.top  = (pony.y + PONY_SIZE/2) + 'px';
      shock.style.borderColor = pony.color || '#fff';
      fx.appendChild(shock);
      setTimeout(()=>shock.remove(), 450);

      pony.state = 'dead';
      setTimeout(()=>{
        ponies = ponies.filter(p => p.id !== pony.id);
        const el = document.getElementById('pony-' + pony.id);
        if(el) el.remove();
      }, 150);
    }

    /* =========================================================
       Pony creation + movement
    ========================================================= */
    function makePonyEl(pony){
      const el = document.createElement('div');
      el.className = 'entity';
      el.id = 'pony-' + pony.id;

      const nameTag = document.createElement('div');
      nameTag.className = 'name-tag';
      nameTag.textContent = pony.name || 'PONY';
      el.appendChild(nameTag);

      const crownWrap = document.createElement('div');
      crownWrap.className = 'crown-container';
      crownWrap.style.display = pony.hasCrown ? 'flex' : 'none';
      const crown = document.createElement('div');
      crown.className = 'crown';
      crownWrap.appendChild(crown);
      el.appendChild(crownWrap);

      const grid = document.createElement('div');
      grid.className = 'pixel-grid';

      for(let i=0;i<121;i++){
        const cell = document.createElement('div');
        cell.style.width = '100%';
        cell.style.height = '100%';
        cell.style.background = 'transparent';
        grid.appendChild(cell);
      }
      el.appendChild(grid);

      return el;
    }

    function renderPonyPixels(el, pony){
      const grid = el.querySelector('.pixel-grid');
      if(!grid) return;
      const cells = grid.children;
      const px = pony.pixels || DEFAULT_PIXELS;
      const col = pony.color || COLORS.CYAN;

      let idx = 0;
      for(let y=0;y<11;y++){
        for(let x=0;x<11;x++){
          const on = !!px[y]?.[x];
          cells[idx].style.background = on ? col : 'transparent';
          idx++;
        }
      }
    }

    function ensurePonyElements(){
      const layer = document.getElementById('layer-pony');
      if(!layer) return;

      const existing = new Set(ponies.map(p=>'pony-'+p.id));
      Array.from(layer.children).forEach(child=>{
        if(!existing.has(child.id)) child.remove();
      });

      ponies.forEach(p=>{
        let el = document.getElementById('pony-' + p.id);
        if(!el){
          el = makePonyEl(p);
          layer.appendChild(el);
          renderPonyPixels(el, p);
        }else{
          const crown = el.querySelector('.crown-container');
          if(crown) crown.style.display = p.hasCrown ? 'flex' : 'none';
          const nt = el.querySelector('.name-tag');
          if(nt && nt.textContent !== p.name) nt.textContent = p.name;
        }
      });
    }

    function updatePoniesMovement(){
      const maxX = gameW - PONY_SIZE - 6;

      ponies.forEach(p=>{
        if(p.state === 'ready'){
          p.frame = (p.frame||0) + 1;
          return;
        }

        if(p.state === 'racing'){
          if(currentGameMode === 'TUG') return;

          const now = Date.now();
          if(p.isManual){
            const dt = now - (p.lastTapTime || now);
            if(dt > 260){
              p.manualSpeed *= 0.92;
              if(p.manualSpeed < 0.15) p.manualSpeed = 0;
            }
          }

          if(p.isJumping){
            p.vz = (p.vz || 0) - 0.8;
            p.z = (p.z || 0) + p.vz;
            if(p.z <= 0){
              p.z = 0; p.vz = 0; p.isJumping = false;
            }
          }

          if(p.isStunned){
            p.stunTimer = (p.stunTimer||0) - 1;
            if(p.stunTimer <= 0){
              p.isStunned = false;
            }
          }

          let v = p.speed || 3.5;
          if(p.isManual) v += (p.manualSpeed || 0);
          if(p.isStunned) v = Math.min(v, 0.6);

          if(currentGameMode === 'HURDLE'){
            obstacles.forEach(ob=>{
              if(ob.passed) return;
              const hitX = ob.x;
              if(p.x + PONY_SIZE >= hitX && p.x <= hitX + ob.width){
                if(!p.isJumping || (p.z||0) < 12){
                  p.x = Math.max(0, p.x - 18);
                  p.manualSpeed = Math.max(0, (p.manualSpeed||0) - 4);
                }else{
                  ob.passed = true;
                }
              }
            });
          }

          p.x = clamp(p.x + v, 0, maxX);
          p.y = clamp(p.y + rand(-0.7, 0.7), 8, GAME_H - PONY_SIZE - 6);
        }

        if(p.state === 'roaming'){
          p.roamDir = p.roamDir || (Math.random()<0.5 ? -1 : 1);
          p.x = clamp(p.x + p.roamDir * rand(0.4, 1.2), 0, maxX);
          if(Math.random() < 0.02) p.roamDir *= -1;
          p.y = clamp(p.y + rand(-0.6, 0.6), 8, GAME_H - PONY_SIZE - 6);
        }
      });
    }

    function checkRaceEnd(){
      if(currentGameMode === 'TUG') return;

      let winner = null;
      const finish = getFinishX();
      ponies.forEach(p=>{
        if(p.state === 'racing' && p.x >= finish){
          winner = p;
        }
      });
      if(!winner) return;

      gameState = 'FINISHED';

      ponies.forEach(p=>{
        p.hasCrown = false;
        if(p.id === winner.id) p.hasCrown = true;
        p.state = 'roaming';
      });

      updateBarText('WIN', '#ffffff');
      setBarVisibility(true);

      broadcast({ type:'sync_ui', label:'DONE', mode:'wait' });

      setTimeout(()=>{
        setBarVisibility(false);
        if(ponyQueue.length > 0){
          gameState = 'WAITING_TO_START';
          waitTimer = 180;
        }else{
          gameState = 'ROAMING';
          broadcast({ type:'sync_ui', label:'START RACE', mode:'start' });
        }
      }, 2600);
    }

    /* =========================================================
       TEAM Mode (TUG) - no auto camera shifting
    ========================================================= */
    function endTugWar(winnerTeam){
      gameState = 'FINISHED';

      let mvp = null, maxTaps = -1;
      ponies.forEach(p=>{
        if(p.team === winnerTeam && (p.tapCount||0) > maxTaps){
          maxTaps = p.tapCount||0; mvp = p;
        }
      });

      const total = ponies.length;
      const eliminationCount = Math.max(0, total - 10);
      const losers = ponies.filter(p=>p.team !== winnerTeam).sort((a,b)=>(a.tapCount||0)-(b.tapCount||0));
      const toExplode = new Set(losers.slice(0, eliminationCount).map(p=>p.id));

      ponies.forEach(p=>{
        p.hasCrown = false;
        if(toExplode.has(p.id)){
          explode(p);
        }else{
          p.state = 'roaming';
        }
      });

      if(mvp) mvp.hasCrown = true;

      updateBarText('WIN', winnerTeam === 1 ? COLORS.BLUE : COLORS.RED);
      setBarVisibility(true);

      document.getElementById('tug-layer').style.display = 'none';
      applyLayout(false);

      broadcast({ type:'sync_ui', label:'DONE', mode:'wait' });

      setTimeout(()=>{
        setBarVisibility(false);
        if(ponyQueue.length > 0){
          gameState = 'WAITING_TO_START';
          waitTimer = 180;
        }else{
          gameState = 'ROAMING';
          broadcast({ type:'sync_ui', label:'START RACE', mode:'start' });
        }
      }, 3200);
    }

    /* =========================================================
       Input handling (host receives from mobile)
    ========================================================= */
    function handleTap(uuid){
      const p = ponies.find(x=>x.playerUUID === uuid);
      if(!p || p.state !== 'racing') return;

      if(currentGameMode === 'TUG'){
        const power = 1.5;
        if(p.team === 1) tugValue = Math.min(100, tugValue + power);
        else tugValue = Math.max(0, tugValue - power);
        p.tapCount = (p.tapCount||0) + 1;

        const fx = document.getElementById('layer-fx');
        const shock = document.createElement('div');
        shock.className='shockwave';
        shock.style.left = (p.x + PONY_SIZE/2) + 'px';
        shock.style.top  = (p.y + PONY_SIZE/2) + 'px';
        shock.style.borderColor = p.team===1 ? COLORS.BLUE : COLORS.RED;
        fx.appendChild(shock);
        setTimeout(()=>shock.remove(), 420);

        return;
      }

      if(currentGameMode === 'RED_LIGHT' && lightState === 'RED'){
        p.isStunned = true;
        p.stunTimer = 60;
        p.manualSpeed = 0;
        return;
      }

      p.isManual = true;
      p.lastTapTime = Date.now();
      p.tapCount = (p.tapCount||0) + 1;
      p.manualSpeed = Math.min((p.manualSpeed||0) + 2.2, 18);
    }

    function handleJump(uuid){
      const p = ponies.find(x=>x.playerUUID === uuid);
      if(!p || p.state !== 'racing') return;
      if(currentGameMode !== 'HURDLE') return;
      if(p.isJumping) return;
      p.isJumping = true;
      p.vz = 12;
      p.isManual = true;
      p.lastTapTime = Date.now();
    }

    /* =========================================================
       Spawn pony (from mobile or bot)
    ========================================================= */
    function requestSpawnPony(name, pixels, color, uuid=null){
      const p = {
        id: Math.random().toString(36).slice(2,9),
        playerUUID: uuid,
        name: (name || 'PONY').toUpperCase().slice(0,8),
        pixels: JSON.parse(JSON.stringify(pixels || DEFAULT_PIXELS)),
        color: color || COLORS.CYAN,
        x: 20,
        y: rand(8, GAME_H - PONY_SIZE - 6),
        z: 0, vz: 0, isJumping:false,
        speed: rand(3.0, 5.2),
        manualSpeed: 0,
        isManual: !!uuid,
        lastTapTime: Date.now(),
        tapCount: 0,
        state: 'racing',
        hasCrown:false,
        isStunned:false,
        stunTimer:0,
        team: 0
      };

      if(gameState === 'RACING' || gameState === 'COOLDOWN' || gameState === 'WAITING_TO_START' || gameState === 'FINISHED'){
        ponyQueue.push(p);
      }else{
        ponies.push(p);
        startCooldown();
      }
    }

    function spawnTestPony(){
      const names = ["SPEEDY","THUNDER","BOLT","COMET","DASH","FLASH","STORM","SHADOW","BLAZE","SPIRIT"];
      const rName = names[Math.floor(Math.random()*names.length)] + Math.floor(Math.random()*99);
      const keys = Object.keys(COLORS);
      const col = COLORS[keys[Math.floor(Math.random()*keys.length)]];
      requestSpawnPony(rName, DEFAULT_PIXELS, col, null);
    }

    /* =========================================================
       Mode transitions
    ========================================================= */
    function startCooldown(){
      if(ponyQueue.length > 0){
        ponies = ponies.concat(ponyQueue);
        ponyQueue = [];
      }

      let selected = document.getElementById('mode-select').value;

      if(selected === 'TUG' && ponies.length < 2){
        selected = 'CLASSIC';
        document.getElementById('mode-select').value = 'CLASSIC';
      }

      if(selected === 'RANDOM'){
        const modes = ['CLASSIC','HURDLE','RED_LIGHT'];
        if(ponies.length >= 2) modes.push('TUG');
        currentGameMode = modes[Math.floor(Math.random()*modes.length)];
      }else{
        currentGameMode = selected;
      }

      gameState = 'COOLDOWN';
      cooldownTimer = 240;
      lastBroadcastText = '';

      obstacles = [];
      if(currentGameMode === 'HURDLE'){
        for(let ox=500; ox<getFinishX()-200; ox += (400 + Math.random()*300)){
          obstacles.push({ x: ox, width: 10, passed:false });
        }
      }

      if(currentGameMode === 'TUG'){
        tugValue = 50;
        const shuffled = [...ponies].sort(()=>Math.random()-0.5);
        shuffled.forEach((p,i)=>{
          p.team = (i%2===0) ? 1 : -1;
          p.tapCount = 0;
        });

        document.getElementById('tug-layer').style.display = 'block';
        document.getElementById('tug-blue-zone').style.width = '50%';
        document.getElementById('tug-red-zone').style.width = '50%';

        applyLayout(false);

        const teamMap = {};
        ponies.forEach(p=>{
          if(p.playerUUID) teamMap[p.playerUUID] = (p.team===1) ? 'BLUE' : 'RED';
        });
        broadcast({ type:'sync_ui', label:'READY', mode:'wait', teamMap });
      }else{
        document.getElementById('tug-layer').style.display = 'none';
        broadcast({ type:'sync_ui', label:'READY', mode:'wait' });
      }

      ponies.forEach(p=>{
        p.state = 'ready';
        p.manualSpeed = 0;
        p.isStunned = false;
        p.isJumping = false; p.z = 0; p.vz = 0;

        if(currentGameMode === 'TUG'){
          const teamMembers = ponies.filter(t=>t.team===p.team).sort((a,b)=>a.id.localeCompare(b.id));
          const idx = teamMembers.findIndex(t=>t.id===p.id);
          const baseY = (GAME_H - PONY_SIZE) / 2 + 8;
          p.y = baseY;

          if(p.team===1){
            p.x = (gameW/2) - 120 - idx*50;
          }else{
            p.x = (gameW/2) + 120 + idx*50;
          }
        }else{
          p.x = 20;
          p.y = rand(8, GAME_H - PONY_SIZE - 6);
        }
      });

      document.getElementById('hud').style.display = 'none';
      document.getElementById('queue-text').style.display = 'none';
      setBarVisibility(true);

      let modeName = 'RUN';
      if(currentGameMode === 'HURDLE') modeName = 'JUMP';
      if(currentGameMode === 'RED_LIGHT') modeName = 'STOP?';
      if(currentGameMode === 'TUG') modeName = 'TEAM';
      updateBarText(modeName, '#fff');
    }

    function startRace(){
      gameState = 'RACING';
      lastBroadcastText = '';
      updateBarText('GO!', '#fff');

      setTimeout(()=>{ if(gameState==='RACING') setBarVisibility(false); }, 900);

      ponies.forEach(p=>{
        p.state = 'racing';
        p.lastTapTime = Date.now();
        p.manualSpeed = 0;
        p.isStunned = false;
      });

      if(currentGameMode === 'TUG'){
        document.getElementById('tug-layer').style.display = 'block';
        broadcast({ type:'sync_ui', label:'PULL!', mode:'tug' });
      }else{
        document.getElementById('tug-layer').style.display = 'none';
        broadcast({ type:'sync_ui', label:'RUN!', mode:'mash', infoText: (currentGameMode==='HURDLE' ? 'TAP RUN / LIFT JUMP' : 'TAP') });
      }

      document.getElementById('hud').style.display = 'block';
      document.getElementById('hud').textContent = (currentGameMode === 'HURDLE') ? 'STATUS: JUMP'
        : (currentGameMode === 'RED_LIGHT') ? 'STATUS: STOP?'
        : (currentGameMode === 'TUG') ? 'TEAM BATTLE'
        : 'STATUS: RUN';

      if(currentGameMode === 'RED_LIGHT'){
        lightState = 'GREEN';
        redLightTimer = 120;
      }
    }

    /* =========================================================
       Main loop
    ========================================================= */
    function updateGameLogic(){
      spawnSnow();
      spawnGrassIfNeeded();

      const queueEl = document.getElementById('queue-text');
      if(ponyQueue.length > 0){
        queueEl.style.display = 'block';
        queueEl.textContent = `${ponyQueue.length} WAITING NEXT ROUND`;
      }else{
        queueEl.style.display = 'none';
      }

      if(gameState === 'WAITING_TO_START'){
        waitTimer--;
        const sec = Math.ceil(waitTimer/60);
        if(sec > 0 && lastBroadcastText !== sec){
          broadcast({ type:'sync_ui', label:`STARTING ${sec}`, mode:'wait' });
          lastBroadcastText = sec;
        }
        if(waitTimer <= 0) startCooldown();
        updatePoniesMovement();
        return;
      }

      if(gameState === 'COOLDOWN'){
        cooldownTimer--;
        const sec = Math.ceil(cooldownTimer/60);
        if(cooldownTimer <= 180){
          updateBarText(String(sec), '#fff');
          if(sec > 0 && lastBroadcastText !== sec){
            broadcast({ type:'sync_ui', label:String(sec), mode:'wait' });
            lastBroadcastText = sec;
          }
        }

        if(cooldownTimer <= 0) startRace();
        ponies.forEach(p=>{ p.frame=(p.frame||0)+1; });
        return;
      }

      if(gameState === 'RACING'){
        if(currentGameMode === 'TUG'){
          ponies.forEach(p=>{
            if(!p.playerUUID && Math.random()<0.015){
              if(p.team===1) tugValue = Math.min(100, tugValue + 1.0);
              else tugValue = Math.max(0, tugValue - 1.0);
              p.tapCount = (p.tapCount||0) + 1;
            }
          });

          document.getElementById('tug-blue-zone').style.width = tugValue + '%';
          document.getElementById('tug-red-zone').style.width = (100 - tugValue) + '%';

          applyLayout(false);

          const front = gameW * (tugValue/100);
          spawnBattleSparks(front);

          ponies.forEach(p=>{
            const teamMembers = ponies.filter(t=>t.team===p.team).sort((a,b)=>a.id.localeCompare(b.id));
            const idx = teamMembers.findIndex(t=>t.id===p.id);
            const baseY = (GAME_H - PONY_SIZE)/2 + 8;
            p.y = baseY;

            let targetX;
            if(p.team===1) targetX = front - 90 - idx*45;
            else targetX = front + 90 + idx*45;

            p.x = p.x + (targetX - p.x) * 0.18;
          });

          if(tugValue >= 95) endTugWar(1);
          if(tugValue <= 5) endTugWar(-1);

          return;
        }

        if(currentGameMode === 'RED_LIGHT'){
          redLightTimer--;
          if(redLightTimer <= 0){
            if(lightState === 'GREEN'){
              lightState = 'RED';
              redLightTimer = 80 + Math.random()*80;
              updateBarText('STOP!', COLORS.RED);
              setBarVisibility(true);
              setTimeout(()=>{ if(gameState==='RACING') setBarVisibility(false); }, 650);
            }else{
              lightState = 'GREEN';
              redLightTimer = 120 + Math.random()*120;
              updateBarText('GO!', COLORS.GREEN);
              setBarVisibility(true);
              setTimeout(()=>{ if(gameState==='RACING') setBarVisibility(false); }, 550);
            }
          }
        }

        updatePoniesMovement();
        checkRaceEnd();
        return;
      }

      if(gameState === 'FINISHED'){
        updatePoniesMovement();
        return;
      }

      if(gameState === 'ROAMING'){
        document.getElementById('hud').style.display = 'block';
        document.getElementById('hud').textContent = 'NOWHERE TO RUN';
        updatePoniesMovement();
      }
    }

    function draw(){
      const gLayer = document.getElementById('layer-grass');
      if(gLayer){
        gLayer.innerHTML = '';
        grass.slice(-220).forEach(g=>{
          const el = document.createElement('div');
          el.className='grass';
          el.style.left = g.x + 'px';
          el.style.top  = g.y + 'px';
          gLayer.appendChild(el);
        });
      }

      if(currentGameMode === 'HURDLE' && (gameState==='RACING' || gameState==='COOLDOWN')){
        const fx = document.getElementById('layer-fx');
        if(fx){
          Array.from(fx.querySelectorAll('.obstacle')).forEach(x=>x.remove());
          obstacles.forEach(ob=>{
            const el = document.createElement('div');
            el.className='obstacle';
            el.style.position='absolute';
            el.style.left = ob.x + 'px';
            el.style.bottom='5px';
            el.style.width = ob.width + 'px';
            el.style.height='30px';
            el.style.background='#fff';
            el.style.boxShadow='0 0 15px #fff';
            fx.appendChild(el);
          });
        }
      }else{
        const fx = document.getElementById('layer-fx');
        if(fx) Array.from(fx.querySelectorAll('.obstacle')).forEach(x=>x.remove());
      }

      ensurePonyElements();
      ponies.forEach(p=>{
        const el = document.getElementById('pony-' + p.id);
        if(!el) return;
        const z = p.z || 0;
        el.style.transform = `translate(${p.x}px, ${p.y - z}px)`;
      });
    }

    function gameLoop(){
      updateGameLogic();
      draw();
      requestAnimationFrame(gameLoop);
    }

    /* =========================================================
       Desktop init
    ========================================================= */
    function initDesktop(){
      document.getElementById('btn-addbot').addEventListener('click', ()=> spawnTestPony());
      document.getElementById('btn-start').addEventListener('click', ()=>{
        if(gameState === 'ROAMING' || gameState === 'WAITING_TO_START') startCooldown();
      });

      // zoom inputs (decimal)
      const zoomSlider = document.getElementById('zoom-slider');
      const zoomInput  = document.getElementById('zoom-input');
      zoomSlider.addEventListener('input', ()=>{
        zoomInput.value = zoomSlider.value;
        layout.scale = parseFloat(zoomSlider.value)/100;
        applyLayout(false);
        broadcast({ type:'settings_broadcast', zoom: layout.scale*100 });
      });
      zoomInput.addEventListener('input', ()=>{
        const v = parseFloat(zoomInput.value);
        if(isNaN(v)) return;
        zoomSlider.value = v;
        layout.scale = v/100;
        applyLayout(false);
        broadcast({ type:'settings_broadcast', zoom: layout.scale*100 });
      });
      zoomInput.addEventListener('keydown', (e)=>{
        if(e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
        e.preventDefault();
        let v = parseFloat(zoomInput.value);
        if(isNaN(v)) v = layout.scale*100;
        v += (e.key==='ArrowUp') ? 0.1 : -0.1;
        v = clamp(v, 1, 500);
        v = Math.round(v*10)/10;
        zoomInput.value = v.toFixed(1);
        zoomSlider.value = v.toFixed(1);
        layout.scale = v/100;
        applyLayout(false);
        broadcast({ type:'settings_broadcast', zoom: layout.scale*100 });
      });

      // stretch (percent)
      const stretchSlider = document.getElementById('stretch-slider');
      const stretchInput  = document.getElementById('stretch-input');
      function setStretchPercent(pct, updateUI=true){
        const v = clamp(parseFloat(pct), 50, 200);
        if(isNaN(v)) return;
        layout.stretchX = v/100;
        if(updateUI){
          stretchSlider.value = Math.round(v);
          stretchInput.value  = Math.round(v);
        }
        applyLayout(false);
        broadcast({ type:'settings_broadcast', stretch: layout.stretchX*100 });
      }
      stretchSlider.addEventListener('input', ()=> setStretchPercent(stretchSlider.value, true));
      stretchInput.addEventListener('input', ()=> setStretchPercent(stretchInput.value, true));

      // x/y
      const xSlider = document.getElementById('x-slider');
      const xInput  = document.getElementById('x-input');
      xSlider.addEventListener('input', ()=>{
        xInput.value = xSlider.value;
        layout.x = parseFloat(xSlider.value);
        applyLayout(false);
      });
      xInput.addEventListener('input', ()=>{
        const v = parseFloat(xInput.value);
        if(isNaN(v)) return;
        layout.x = v;
        xSlider.value = Math.round(v);
        applyLayout(false);
      });

      const ySlider = document.getElementById('y-slider');
      const yInput  = document.getElementById('y-input');
      ySlider.addEventListener('input', ()=>{
        yInput.value = ySlider.value;
        layout.y = parseFloat(ySlider.value);
        applyLayout(false);
      });
      yInput.addEventListener('input', ()=>{
        const v = parseFloat(yInput.value);
        if(isNaN(v)) return;
        layout.y = v;
        ySlider.value = Math.round(v);
        applyLayout(false);
      });

      // length
      const lenInput = document.getElementById('len-input');
      lenInput.addEventListener('change', ()=> setTrackLength(lenInput.value, true));

      // snow
      const snowToggle = document.getElementById('snow-toggle');
      const snowLabel = document.getElementById('snow-toggle-label');
      snowToggle.addEventListener('change', ()=>{
        snowEnabled = snowToggle.checked;
        snowLabel.textContent = snowEnabled ? 'ON' : 'OFF';
        if(!snowEnabled) document.getElementById('layer-snow').innerHTML='';
        broadcast({ type:'settings_broadcast', snowEnabled });
      });

      // border
      const borderToggle = document.getElementById('border-toggle');
      const borderLabel = document.getElementById('border-toggle-label');
      const borderWidthInput = document.getElementById('border-width-input');

      borderToggle.addEventListener('change', ()=>{
        trackBorderEnabled = borderToggle.checked;
        borderLabel.textContent = trackBorderEnabled ? 'ON' : 'OFF';
        setTrackBorder(trackBorderEnabled, trackBorderWidth, false);
        broadcast({ type:'settings_broadcast', borderEnabled: trackBorderEnabled, borderWidth: trackBorderWidth });
      });
      borderWidthInput.addEventListener('input', ()=>{
        const v = parseFloat(borderWidthInput.value);
        if(isNaN(v)) return;
        trackBorderWidth = v;
        setTrackBorder(trackBorderEnabled, trackBorderWidth, false);
        broadcast({ type:'settings_broadcast', borderEnabled: trackBorderEnabled, borderWidth: trackBorderWidth });
      });

      // wheel: ctrl zoom / normal pan y
      const desk = document.getElementById('desktop-view');
      desk.addEventListener('wheel', (e)=>{
        e.preventDefault();
        if(e.ctrlKey){
          const zoomSpeed = 0.001;
          layout.scale = clamp(layout.scale - e.deltaY*zoomSpeed, 0.1, 5.0);
        }else{
          layout.y -= e.deltaY * 1.0;
        }
        applyLayout(true);
      }, { passive:false });

      window.addEventListener('resize', ()=> applyLayout(true));
      window.addEventListener('keydown', (e)=>{
        if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='SELECT')) return;
        if(e.key === '0') fitScreen();
      });

      // peer host
      peer = new Peer(null, PEER_CONFIG);

      peer.on('open', id=>{
        hostId = id;
        const url = `${location.origin}${location.pathname}?host=${id}`;
        const qr = document.getElementById('qrcode');
        qr.innerHTML='';
        new QRCode(qr, { text:url, width:86, height:86, colorDark:"#000", colorLight:"#fff", correctLevel:QRCode.CorrectLevel.L });
        fitScreen();
      });

      peer.on('connection', c=>{
        c.on('data', (data)=>{
          if(data?.type === 'request_settings'){
            c.send({
              type:'settings',
              zoom: layout.scale*100,
              stretch: layout.stretchX*100,
              x: layout.x,
              y: layout.y,
              length: gameW,
              mode: document.getElementById('mode-select').value,
              snowEnabled: !!snowEnabled,
              borderEnabled: !!trackBorderEnabled,
              borderWidth: trackBorderWidth
            });
            return;
          }

          if(data?.type === 'host_control' && data.payload){
            const p = data.payload;

            if(p.action === 'set_layout'){
              const z = parseFloat(p.zoom);
              const sx = parseFloat(p.stretch);
              const x = parseFloat(p.x);
              const y = parseFloat(p.y);

              if(!isNaN(z)) layout.scale = z/100;
              if(!isNaN(sx)) layout.stretchX = clamp(sx, 50, 200)/100;
              if(!isNaN(x)) layout.x = x;
              if(!isNaN(y)) layout.y = y;

              applyLayout(true);

              // keep fitScreen as user manual (0 key), don't auto refit
            }

            if(p.action === 'set_length'){
              setTrackLength(p.length, true);
            }

            if(p.action === 'set_mode'){
              if(p.mode) document.getElementById('mode-select').value = p.mode;
            }

            if(p.action === 'set_snow'){
              snowEnabled = !!p.enabled;
              syncDesktopSnowUI();
            }

            if(p.action === 'set_border'){
              const en = (p.enabled !== undefined) ? !!p.enabled : trackBorderEnabled;
              const w = (p.width !== undefined) ? p.width : trackBorderWidth;
              setTrackBorder(en, w, true);
            }

            if(p.action === 'add_bot'){
              spawnTestPony();
            }

            return;
          }

          if(data?.type === 'check_reconnect'){
            const uuid = data.uuid;
            const exists = ponies.find(p=>p.playerUUID===uuid) || ponyQueue.find(p=>p.playerUUID===uuid);
            if(exists) c.send({ type:'reconnect_success' });
            return;
          }

          if(data?.type === 'spawn'){
            const payload = data.payload || {};
            const uuid = payload.uuid;
            const exists = ponies.find(p=>p.playerUUID===uuid) || ponyQueue.find(p=>p.playerUUID===uuid);
            if(!exists){
              requestSpawnPony(payload.name, payload.pixels, payload.color, uuid);
            }
            if(gameState === 'RACING') c.send({ type:'sync_ui', label:'WAITING', mode:'wait' });
            return;
          }

          if(data?.type === 'tap'){ handleTap(data.uuid); return; }
          if(data?.type === 'jump'){ handleJump(data.uuid); return; }

          if(data?.type === 'force_start'){
            if(gameState === 'ROAMING' || gameState === 'WAITING_TO_START') startCooldown();
            return;
          }
        });
      });

      peer.on('error', (err)=>{
        console.error('Peer error', err);
        alert('Network Error: ' + err.type + '\nTry refreshing.');
      });
    }

    /* =========================================================
       Mobile init (editor + controller + hidden admin)
    ========================================================= */
    let mobileGrid = JSON.parse(JSON.stringify(DEFAULT_PIXELS));
    let mSelectedColor = COLORS.CYAN;
    let playerUUID = null;
    let mTeam = null;

    let mTitleTapCount = 0;
    let mTitleTapTimer = null;

    function initMobile(){
      playerUUID = localStorage.getItem('pony_uuid');
      if(!playerUUID){
        playerUUID = crypto?.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2)+Date.now());
        localStorage.setItem('pony_uuid', playerUUID);
      }

      buildColorPicker('m-colors', (col)=>{ mSelectedColor = col; });
      buildEditorGrid('m-grid', mobileGrid, (x,y,on)=>{ mobileGrid[y][x] = on ? 1 : 0; });

      document.getElementById('m-clear').addEventListener('click', ()=>{
        mobileGrid = JSON.parse(JSON.stringify(DEFAULT_PIXELS));
        redrawEditorGrid('m-grid', mobileGrid);
      });

      document.getElementById('m-send').addEventListener('click', ()=>{ sendMobileSpawn(); });

      const mBtn = document.getElementById('m-btn');
      mBtn.addEventListener('pointerdown', (e)=>{
        e.preventDefault();
        if(!conn || !conn.open) return;
        conn.send({ type:'tap', uuid: playerUUID });
      });

      // motion jump (lift phone)
      let lastShakeTime = 0;
      window.addEventListener('devicemotion', (evt)=>{
        const now = Date.now();
        if(now - lastShakeTime < 600) return;
        const a = evt.accelerationIncludingGravity;
        if(!a) return;
        const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
        if(mag > 22){
          lastShakeTime = now;
          if(conn && conn.open){
            conn.send({ type:'jump', uuid: playerUUID });
          }
        }
      }, { passive:true });

      // swipe jump disabled (gated)
      let touchStartY = null;
      mBtn.addEventListener('touchstart', (e)=>{
        if(!swipeJumpEnabled) return;
        touchStartY = e.touches[0].clientY;
      }, { passive:true });
      mBtn.addEventListener('touchend', (e)=>{
        if(!swipeJumpEnabled) return;
        if(touchStartY === null) return;
        const endY = e.changedTouches[0].clientY;
        const dy = touchStartY - endY;
        if(dy > 45 && conn && conn.open){
          conn.send({ type:'jump', uuid: playerUUID });
        }
        touchStartY = null;
      }, { passive:true });

      const title = document.getElementById('m-title');
      title.addEventListener('click', ()=>{
        const editorVisible = document.getElementById('m-editor-ui').style.display !== 'none';
        if(!editorVisible) return;

        mTitleTapCount++;
        if(mTitleTapTimer) clearTimeout(mTitleTapTimer);
        mTitleTapTimer = setTimeout(()=>{ mTitleTapCount = 0; }, 900);

        if(mTitleTapCount >= 5){
          mTitleTapCount = 0;
          openMobileAdmin();
        }
      });

      document.getElementById('m-admin-back').addEventListener('click', closeMobileAdmin);
      document.getElementById('m-admin-addbot').addEventListener('click', ()=>{
        if(conn && conn.open) conn.send({ type:'host_control', payload:{ action:'add_bot' } });
      });
      document.getElementById('m-admin-apply').addEventListener('click', ()=>{
        if(!conn || !conn.open) return;

        const z = parseFloat(document.getElementById('m-admin-zoom').value);
        const stretch = parseFloat(document.getElementById('m-admin-stretch').value);
        const x = parseFloat(document.getElementById('m-admin-x').value);
        const y = parseFloat(document.getElementById('m-admin-y').value);
        const len = parseFloat(document.getElementById('m-admin-len').value);
        const mode = document.getElementById('m-admin-mode').value;

        const snow = document.getElementById('m-admin-snow').checked;
        const border = document.getElementById('m-admin-border').checked;
        const bw = parseFloat(document.getElementById('m-admin-borderw').value);

        conn.send({ type:'host_control', payload:{ action:'set_layout', zoom:z, stretch:stretch, x:x, y:y } });
        conn.send({ type:'host_control', payload:{ action:'set_length', length:len } });
        conn.send({ type:'host_control', payload:{ action:'set_mode', mode } });
        conn.send({ type:'host_control', payload:{ action:'set_snow', enabled:snow } });
        conn.send({ type:'host_control', payload:{ action:'set_border', enabled:border, width:bw } });

        closeMobileAdmin();
      });

      const params = new URLSearchParams(location.search);
      hostId = params.get('host');
      connectToHost(hostId);
    }

    function openMobileAdmin(){
      document.getElementById('m-admin').style.display = 'flex';
      if(conn && conn.open) conn.send({ type:'request_settings' });
    }
    function closeMobileAdmin(){
      document.getElementById('m-admin').style.display = 'none';
    }

    function connectToHost(host){
      document.getElementById('m-status').textContent = 'Connecting...';
      try{
        const clientPeer = new Peer(null, PEER_CONFIG);
        clientPeer.on('open', ()=>{
          conn = clientPeer.connect(host);
          conn.on('open', ()=>{
            document.getElementById('m-status').textContent = 'Connected';
            conn.send({ type:'check_reconnect', uuid: playerUUID });
            conn.send({ type:'request_settings' });
          });

          conn.on('data', (data)=>{
            if(!data) return;

            if(data.type === 'reconnect_success'){
              document.getElementById('m-status').textContent = 'Reconnected';
              return;
            }

            if(data.type === 'settings'){
              fillMobileAdminSettings(data);
              return;
            }

            if(data.type === 'sync_ui'){
              updateMobileControllerState(data);
              return;
            }
          });

          conn.on('close', ()=>{ document.getElementById('m-status').textContent = 'Disconnected'; });
          conn.on('error', ()=>{ document.getElementById('m-status').textContent = 'Connection error'; });
        });

        clientPeer.on('error', ()=>{ document.getElementById('m-status').textContent = 'Network error'; });
      }catch(e){
        console.error(e);
        document.getElementById('m-status').textContent = 'Failed';
      }
    }

    function fillMobileAdminSettings(s){
      document.getElementById('m-admin-zoom').value = Number(s.zoom ?? 100).toFixed(1);
      document.getElementById('m-admin-stretch').value = Math.round(s.stretch ?? 100);
      document.getElementById('m-admin-x').value = Number(s.x ?? 0).toFixed(1);
      document.getElementById('m-admin-y').value = Number(s.y ?? 0).toFixed(1);
      document.getElementById('m-admin-len').value = Math.round(s.length ?? gameW);
      document.getElementById('m-admin-mode').value = s.mode ?? 'CLASSIC';

      document.getElementById('m-admin-snow').checked = !!s.snowEnabled;
      document.getElementById('m-admin-snow-label').textContent = s.snowEnabled ? 'ON' : 'OFF';
      document.getElementById('m-admin-border').checked = !!s.borderEnabled;
      document.getElementById('m-admin-border-label').textContent = s.borderEnabled ? 'ON' : 'OFF';
      document.getElementById('m-admin-borderw').value = Number(s.borderWidth ?? 2).toFixed(1);

      document.getElementById('m-admin-snow').addEventListener('change', ()=>{
        document.getElementById('m-admin-snow-label').textContent = document.getElementById('m-admin-snow').checked ? 'ON' : 'OFF';
      }, { once:true });
      document.getElementById('m-admin-border').addEventListener('change', ()=>{
        document.getElementById('m-admin-border-label').textContent = document.getElementById('m-admin-border').checked ? 'ON' : 'OFF';
      }, { once:true });
    }

    function updateMobileControllerState(msg){
      const label = msg.label || 'WAIT';
      const mode = msg.mode || 'wait';

      if(msg.teamMap && playerUUID && msg.teamMap[playerUUID]){
        mTeam = msg.teamMap[playerUUID];
      }

      const mInfo = document.getElementById('m-info');
      const mBtn = document.getElementById('m-btn');

      mInfo.textContent = label;

      mBtn.classList.remove('btn-wait','btn-mash','btn-start','btn-team-red','btn-team-blue');

      if(mode === 'start'){
        mBtn.classList.add('btn-start');
        mBtn.textContent = 'START';
      }else if(mode === 'mash'){
        mBtn.classList.add('btn-mash');
        mBtn.textContent = 'RUN';
      }else if(mode === 'tug'){
        mBtn.textContent = 'PULL';
        if(mTeam === 'BLUE') mBtn.classList.add('btn-team-blue');
        else if(mTeam === 'RED') mBtn.classList.add('btn-team-red');
        else mBtn.classList.add('btn-mash');
      }else{
        mBtn.classList.add('btn-wait');
        mBtn.textContent = 'WAIT';
      }
    }

    function sendMobileSpawn(){
      if(!conn || !conn.open){
        document.getElementById('m-status').textContent = 'Not connected';
        return;
      }
      const name = (document.getElementById('m-name').value || 'PLAYER').toUpperCase().slice(0,8);

      conn.send({
        type:'spawn',
        payload:{
          uuid: playerUUID,
          name,
          pixels: mobileGrid,
          color: mSelectedColor
        }
      });

      document.getElementById('m-editor-ui').style.display = 'none';
      document.getElementById('m-controller').style.display = 'flex';
      document.getElementById('m-info').textContent = 'WAIT';
    }

    /* =========================================================
       Mobile editor helpers
    ========================================================= */
    function buildColorPicker(containerId, onPick){
      const wrap = document.getElementById(containerId);
      wrap.innerHTML = '';
      const entries = Object.entries(COLORS);

      entries.forEach(([k,v], idx)=>{
        const dot = document.createElement('div');
        dot.className = 'c-dot' + (idx===0 ? ' active' : '');
        dot.style.background = v;
        dot.addEventListener('click', ()=>{
          wrap.querySelectorAll('.c-dot').forEach(d=>d.classList.remove('active'));
          dot.classList.add('active');
          onPick(v);
        });
        wrap.appendChild(dot);
      });

      onPick(entries[0][1]);
    }

    function buildEditorGrid(containerId, gridData, onToggle){
      const gridEl = document.getElementById(containerId);
      gridEl.innerHTML = '';

      const cellSize = 28;
      gridEl.style.width = (cellSize*11 + 2*10) + 'px';

      let drawing = false;
      let drawValue = 1;

      const setCell = (x,y,val)=>{
        const idx = y*11 + x;
        const cell = gridEl.children[idx];
        if(!cell) return;
        cell.style.background = val ? mSelectedColor : '#000';
        onToggle(x,y,val);
      };

      for(let y=0;y<11;y++){
        for(let x=0;x<11;x++){
          const cell = document.createElement('div');
          cell.className = 'editor-cell';
          cell.style.background = gridData[y][x] ? mSelectedColor : '#000';

          cell.addEventListener('pointerdown', (e)=>{
            e.preventDefault();
            drawing = true;
            drawValue = gridData[y][x] ? 0 : 1;
            setCell(x,y,drawValue);
          });
          cell.addEventListener('pointerenter', ()=>{
            if(!drawing) return;
            setCell(x,y,drawValue);
          });

          gridEl.appendChild(cell);
        }
      }

      window.addEventListener('pointerup', ()=>{ drawing=false; });
    }

    function redrawEditorGrid(containerId, gridData){
      const gridEl = document.getElementById(containerId);
      for(let y=0;y<11;y++){
        for(let x=0;x<11;x++){
          const idx = y*11 + x;
          const cell = gridEl.children[idx];
          if(cell) cell.style.background = gridData[y][x] ? mSelectedColor : '#000';
        }
      }
    }

    /* =========================================================
       Boot
    ========================================================= */
    window.addEventListener('load', ()=>{
      document.documentElement.style.setProperty('--game-w', gameW + 'px');
      document.documentElement.style.setProperty('--game-h', GAME_H + 'px');
      setTrackBorder(true, 2, true);
      syncDesktopSnowUI();

      const params = new URLSearchParams(location.search);
      const isMobile = params.has('host');

      if(isMobile){
        document.getElementById('desktop-view').style.display = 'none';
        document.getElementById('mobile-view').style.display = 'flex';
        initMobile();
      }else{
        document.getElementById('desktop-view').style.display = 'block';
        initDesktop();
        fitScreen();
        requestAnimationFrame(gameLoop);
      }
    });
  </script>
</body>
</html>
