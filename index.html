<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HORSE RUNRUN</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg: #111;
            --color-primary: #40e0d0; /* Turquoise */
            --color-panel: #004d40;
            --color-border: #00695c;
            --color-border-dark: #00251a;
            --scale: 4px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            font-family: 'VT323', monospace;
            color: var(--color-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* 禁止页面整体回弹 */
            overscroll-behavior: none;
        }

        /* 通用样式类 */
        .hidden { display: none !important; }
        .vfd-glow { text-shadow: 0 0 5px rgba(64, 224, 208, 0.6), 0 0 10px rgba(64, 224, 208, 0.4); }
        
        .btn {
            background: #00251a;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            padding: 10px 30px;
            font-family: 'VT323', monospace;
            font-size: 1.4rem;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(64, 224, 208, 0.2);
            transition: all 0.2s;
            touch-action: manipulation;
        }
        .btn:hover { background: var(--color-primary); color: #00251a; }
        .btn:active { transform: translateY(2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-primary);
            opacity: 0.8;
        }

        /* 背景网格 */
        .bg-grid {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            pointer-events: none;
            background-image: linear-gradient(var(--color-border) 1px, transparent 1px), 
                              linear-gradient(90deg, var(--color-border) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }

        /* --- 布局容器 --- */
        #main-layout {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 20px;
            transform-origin: center;
            transform: scale(1);
        }

        /* --- 主屏幕区域 (左侧) --- */
        #game-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .screen-frame {
            width: 900px; 
            height: 120px;
            background: var(--color-panel);
            border-top: 1px solid var(--color-border);
            border-left: 1px solid var(--color-border);
            border-right: 4px solid var(--color-border-dark);
            border-bottom: 4px solid var(--color-border-dark);
            position: relative;
            border-radius: 4px;
            box-shadow: 0 0 50px rgba(64, 224, 208, 0.1);
        }

        .screen-glass {
            position: absolute;
            inset: 2px;
            background: #000;
            border: 1px solid #222;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }

        .screen-grid {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            background-image: radial-gradient(var(--color-primary) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* 装饰螺丝 */
        .screw {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #1a1c20;
            border: 1px solid var(--color-border);
            border-radius: 50%;
        }
        .tl { top: 2px; left: 2px; } .tr { top: 2px; right: 2px; }
        .bl { bottom: 2px; left: 2px; } .br { bottom: 2px; right: 2px; }

        /* 起跑线 */
        .start-line {
            position: absolute;
            top: 0; bottom: 0; left: 12px;
            width: 1px;
            border-left: 2px dashed rgba(64, 224, 208, 0.3);
        }

        /* HUD */
        .hud {
            position: absolute;
            bottom: 4px; right: 8px;
            font-size: 10px;
            opacity: 0.4;
            letter-spacing: 2px;
        }

        /* --- 二维码区域 (右侧) --- */
        #qr-section {
            height: 120px;
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            border: 2px solid var(--color-border);
            background: rgba(0, 37, 26, 0.8);
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(64, 224, 208, 0.1);
        }

        .qr-text-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            min-width: 80px;
        }

        #qrcode {
            background: white;
            padding: 5px;
            width: 90px;
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; 
            border-radius: 2px;
        }
        
        #qrcode img {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        .qr-text {
            font-size: 1.2rem;
            color: var(--color-primary);
            line-height: 1.1;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .qr-sub-text {
            font-size: 0.8rem;
            color: var(--color-primary);
            opacity: 0.6;
            letter-spacing: 1px;
        }

        /* --- 实体 (小马/草) --- */
        .entity {
            position: absolute;
            will-change: transform;
        }

        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 32px; /* 8 cols * 4px scale */
            height: 32px;
        }
        
        .pixel {
            width: 4px;
            height: 4px;
        }

        /* 像素皇冠容器 (SVG版) */
        .crown-container {
            position: absolute;
            top: -38px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            animation: bounce 1s infinite;
            z-index: 10;
        }

        .name-tag {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
            opacity: 0.8;
            text-shadow: 1px 1px 0 #000;
        }

        .grass {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: #69f0ae;
            box-shadow: 0 0 4px #69f0ae;
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -4px); }
        }

        /* --- 模态框 --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1c20;
            border: 2px solid var(--color-primary);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(64, 224, 208, 0.3);
            text-align: center;
            max-width: 90%;
        }

        /* 绘图编辑器 */
        .editor-grid {
            display: grid;
            grid-template-rows: repeat(8, 1fr);
            gap: 1px;
            background: #222;
            padding: 4px;
            border: 1px solid var(--color-border);
            margin: 0 auto;
            width: fit-content;
            /* 关键：阻止触摸默认行为 */
            touch-action: none;
            -webkit-user-select: none;
        }
        .editor-row { display: flex; gap: 1px; }
        .editor-cell {
            width: 40px; /* 加大触控面积 */
            height: 40px;
            background: #001a15;
            border: 1px solid #333;
            cursor: pointer;
        }
        .editor-cell.active {
            opacity: 1;
            box-shadow: 0 0 4px currentColor;
        }

        .color-picker {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .color-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.selected { border-color: white; transform: scale(1.2); }

        /* 移动端视图布局调整 */
        #mobile-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #000;
            padding: 20px;
            overflow: hidden;
        }

        .mobile-header {
            display: flex; 
            justify-content: space-between; 
            border-bottom: 1px solid var(--color-border); 
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* 输入框 */
        input[type="text"] {
            background: #00251a;
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            padding: 10px;
            font-family: inherit;
            text-align: center;
            font-size: 1.4rem;
            width: 100%;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        input:focus { outline: none; border-color: var(--color-primary); }

        .mobile-controls-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .mobile-canvas-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .mobile-controls-bottom {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <div id="desktop-view">
        <div id="main-layout">
            
            <div id="game-section">
                <div id="game-container">
                    <div class="screen-frame">
                        <div class="screw tl"></div><div class="screw tr"></div>
                        <div class="screw bl"></div><div class="screw br"></div>
                        
                        <div class="screen-glass" id="screen-glass">
                            <div class="screen-grid"></div>
                            <div class="start-line"></div>
                            <div class="hud">MODE:RACE // STATUS:LIVE</div>
                            
                            <div id="grass-layer"></div>
                            <div id="pony-layer"></div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" style="margin-top:20px;" onclick="openEditor()">+ NEW RUNNER</button>
            </div>

            <div id="qr-section">
                <div class="qr-text-group">
                    <div class="qr-text">SCAN<br>TO JOIN</div>
                    <div class="qr-sub-text">MOBILE</div>
                </div>
                <div id="qrcode"></div>
            </div>

        </div>
    </div>

    <div id="mobile-view" class="hidden">
        
        <div class="mobile-header">
            <span style="font-size: 1.2rem;" class="vfd-glow">REMOTE LINK</span>
            <span id="mobile-status" style="background: #004d40; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">CONNECTING</span>
        </div>

        <div class="mobile-controls-top">
            <input type="text" id="mobile-name-input" placeholder="ENTER NAME" maxlength="8">
            <div class="color-picker" id="mobile-color-picker"></div>
        </div>
        
        <div class="mobile-canvas-area">
            <div id="mobile-editor-container"></div>
        </div>

        <div class="mobile-controls-bottom">
            <button class="btn btn-outline" style="border-color: #ff5252; color: #ff5252;" onclick="clearMobileEditor()">CLEAR</button>
            <button class="btn" style="flex: 1;" onclick="sendPonyFromMobile()">CAST TO SCREEN</button>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="vfd-glow" style="margin-top: 0;">// ENTITY DESIGNER</h2>
            <input type="text" id="editor-name" placeholder="NAME" maxlength="8" value="CUSTOM">
            
            <div class="color-picker" id="desktop-color-picker"></div>
            
            <div id="desktop-editor-grid" class="editor-grid"></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn" style="border-color: #ff5252; color: #ff5252;" onclick="clearEditor()">CLEAR</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="border-color: transparent;" onclick="closeEditor()">CANCEL</button>
                    <button class="btn" onclick="savePony()">CREATE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 常量与配置 ---
        const SCREEN_WIDTH = 900; 
        const SCREEN_HEIGHT = 120;
        const PONY_SCALE = 4;
        const PONY_WIDTH = 8 * PONY_SCALE; // 8x8 Grid
        const PONY_HEIGHT = 8 * PONY_SCALE;
        
        const COLORS = {
            TURQUOISE: '#40e0d0',
            AMBER: '#ffb300',
            RED: '#ff5252',
            GREEN: '#69f0ae',
            PURPLE: '#e040fb',
            WHITE: '#ffffff',
            GOLD: '#facc15' 
        };

        // 默认像素画 (8x8)
        const DEFAULT_FRAME_1 = [
            [0,0,0,0,0,0,1,0],
            [0,0,0,0,0,1,1,1],
            [0,0,0,0,0,1,1,0],
            [0,0,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,0],
            [1,1,1,1,1,1,1,0],
            [0,1,0,0,0,1,0,0],
            [0,1,0,0,0,1,0,0]
        ];

        // 状态管理
        let ponies = []; 
        let grass = [];  
        let peerId = null;
        let peer = null;
        let conn = null; 
        
        // 桌面和移动端使用独立的 Grid 变量，互不干扰
        let editorGrid = JSON.parse(JSON.stringify(DEFAULT_FRAME_1)); 
        let mobileEditorGrid = JSON.parse(JSON.stringify(DEFAULT_FRAME_1));
        
        let selectedColor = COLORS.TURQUOISE;

        // --- 初始化 ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            const connectTo = params.get('connectTo');

            if (connectTo) {
                document.getElementById('desktop-view').classList.add('hidden');
                document.getElementById('mobile-view').classList.remove('hidden');
                initMobile(connectTo);
            } else {
                initDesktop();
            }
        }

        // --- 桌面端逻辑 ---
        function initDesktop() {
            initPeerHost();
            buildColorPicker('desktop-color-picker');
            buildEditorGrid('desktop-editor-grid', editorGrid); 
            requestAnimationFrame(gameLoop);
        }

        function initPeerHost() {
            peer = new Peer();
            peer.on('open', (id) => {
                peerId = id;
                generateFixedQR();
            });
            peer.on('connection', (c) => {
                c.on('data', (data) => {
                    createPony(data.name, data.pixels, data.color);
                });
            });
        }

        // --- 游戏循环 ---
        function gameLoop() {
            updatePhysics();
            render();
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics() {
            const totalPonies = ponies.length;
            const finishedPonies = ponies.filter(p => p.state === 'finished').length;
            const isRaceOngoing = ponies.some(p => p.state === 'racing');
            let allFinishedTrigger = (totalPonies > 0 && finishedPonies === totalPonies);

            if (!isRaceOngoing && totalPonies > 0 && grass.length < 8 && Math.random() < 0.01) {
                grass.push({
                    id: Math.random(),
                    x: 20 + Math.random() * (SCREEN_WIDTH - 40),
                    y: 40 + Math.random() * (SCREEN_HEIGHT - 60)
                });
            }

            let winnerFoundThisFrame = false;
            const existingWinner = ponies.some(p => p.hasCrown);

            ponies.forEach(p => {
                if (allFinishedTrigger && p.state === 'finished') {
                    p.state = 'roaming';
                    p.timer = 0;
                    p.targetX = null;
                    const side = Math.floor(Math.random() * 4); 
                    const SAFE_TOP = 35; 
                    const SAFE_H = SCREEN_HEIGHT - PONY_HEIGHT - 10 - SAFE_TOP;
                    
                    if (side === 0) { p.x = 20 + Math.random() * (SCREEN_WIDTH - 100); p.y = -50; }
                    else if (side === 1) { p.x = SCREEN_WIDTH + 10; p.y = SAFE_TOP + Math.random() * SAFE_H; }
                    else if (side === 2) { p.x = 20 + Math.random() * (SCREEN_WIDTH - 100); p.y = SCREEN_HEIGHT + 10; }
                    else { p.x = -50; p.y = SAFE_TOP + Math.random() * SAFE_H; }
                }

                if (p.state === 'racing') {
                    let variance = 0.5 + Math.random() * 1.5;
                    p.x += p.speed * variance;
                    p.facing = 'right';

                    if (p.x > SCREEN_WIDTH + 20) {
                        p.state = 'finished';
                        if (!existingWinner && !winnerFoundThisFrame) {
                            p.hasCrown = true;
                            winnerFoundThisFrame = true;
                        }
                    }
                } 
                else if (p.state === 'finished') {
                    p.x += 0.1;
                }
                else if (p.state === 'roaming') {
                    let targetGrass = null;
                    let minDist = 150;
                    grass.forEach(g => {
                        const dx = g.x - p.x;
                        const dy = g.y - p.y;
                        const d = Math.sqrt(dx*dx + dy*dy);
                        if (d < minDist) {
                            minDist = d;
                            targetGrass = g;
                        }
                    });

                    if (targetGrass) {
                        p.state = 'walking_to_food';
                    } else {
                        handleRoamingMovement(p);
                    }
                }
                else if (p.state === 'walking_to_food') {
                    let closest = null; 
                    let d = 9999;
                    grass.forEach(item => {
                        let dist = Math.sqrt(Math.pow(item.x - p.x, 2) + Math.pow(item.y - p.y, 2));
                        if(dist < d) { d = dist; closest = item; }
                    });

                    if (!closest) {
                        p.state = 'roaming';
                    } else {
                        const dx = closest.x - p.x;
                        const dy = closest.y - p.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < 5) {
                            p.state = 'eating';
                            p.timer = 100;
                            grass = grass.filter(item => item !== closest);
                        } else {
                            p.x += (dx/dist) * 1.0;
                            p.y += (dy/dist) * 1.0;
                            p.facing = dx > 0 ? 'right' : 'left';
                        }
                    }
                }
                else if (p.state === 'eating') {
                    if (p.timer > 0) p.timer--;
                    else p.state = 'roaming';
                }
            });

            if (!isRaceOngoing && ponies.length > 10) {
                const winner = ponies.find(p => p.hasCrown);
                const others = ponies.filter(p => !p.hasCrown);
                const keepCount = winner ? 9 : 10;
                const keptOthers = others.slice(-keepCount);
                ponies = winner ? [...keptOthers, winner] : keptOthers;
            }
        }

        function handleRoamingMovement(p) {
            if (p.x < -50 || p.x > SCREEN_WIDTH || p.y < -50 || p.y > SCREEN_HEIGHT) {
                const dx = (SCREEN_WIDTH/2) - p.x;
                const dy = (SCREEN_HEIGHT/2) - p.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                p.x += (dx/len) * 1.5;
                p.y += (dy/len) * 1.5;
                p.facing = dx > 0 ? 'right' : 'left';
                return;
            }

            if (p.timer > 0) {
                p.timer--;
            } else {
                if (Math.random() > 0.3) {
                    p.targetX = Math.random() * (SCREEN_WIDTH - 40);
                    p.timer = 60 + Math.random() * 100;
                } else {
                    p.state = 'eating';
                    p.timer = 60;
                }
            }

            if (p.targetX !== undefined && p.targetX !== null) {
                const dist = p.targetX - p.x;
                if (Math.abs(dist) > 2) {
                    p.x += Math.sign(dist) * 0.5;
                    p.facing = dist > 0 ? 'right' : 'left';
                } else {
                    p.targetX = null;
                }
            }

            if (Math.random() < 0.05) {
                p.y += (Math.random() - 0.5) * 2;
                if (p.y < 35) p.y = 35;
                if (p.y > SCREEN_HEIGHT - 40) p.y = SCREEN_HEIGHT - 40;
            }
        }

        // --- 渲染 ---
        function render() {
            const ponyLayer = document.getElementById('pony-layer');
            const grassLayer = document.getElementById('grass-layer');
            
            grassLayer.innerHTML = '';
            grass.forEach(g => {
                const el = document.createElement('div');
                el.className = 'grass';
                el.style.transform = `translate3d(${g.x}px, ${g.y}px, 0)`;
                grassLayer.appendChild(el);
            });

            const existingNodes = Array.from(ponyLayer.children);
            const activeIds = new Set(ponies.map(p => p.id));

            existingNodes.forEach(node => {
                if (!activeIds.has(node.id)) node.remove();
            });

            ponies.forEach(p => {
                let el = document.getElementById(p.id);
                if (!el) {
                    el = createPonyDOM(p);
                    ponyLayer.appendChild(el);
                }
                
                el.style.transform = `translate3d(${p.x}px, ${p.y}px, 0)`;
                el.style.zIndex = Math.floor(p.y);

                const pixelContainer = el.querySelector('.pixel-grid-container');
                if (p.facing === 'left') {
                    pixelContainer.style.transform = 'scaleX(-1)';
                } else {
                    pixelContainer.style.transform = 'scaleX(1)';
                }

                const crownContainer = el.querySelector('.crown-container');
                if (p.hasCrown) {
                    crownContainer.classList.remove('hidden');
                } else {
                    crownContainer.classList.add('hidden');
                }

                const nameEl = el.querySelector('.name-tag');
                nameEl.style.color = p.hasCrown ? COLORS.GOLD : p.color;
                nameEl.style.opacity = p.hasCrown ? 1 : 0.8;

                updatePonyAnimation(p, el);
            });
        }

        function createPonyDOM(p) {
            const div = document.createElement('div');
            div.id = p.id;
            div.className = 'entity';
            div.style.width = PONY_WIDTH + 'px';
            div.style.height = PONY_HEIGHT + 'px';

            // SVG 皇冠
            const crownContainer = document.createElement('div');
            crownContainer.className = 'crown-container hidden';
            crownContainer.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#facc15" stroke="#facc15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path>
                </svg>
            `;
            crownContainer.style.filter = "drop-shadow(0 0 5px rgba(250, 204, 21, 0.8))";
            div.appendChild(crownContainer);

            const name = document.createElement('div');
            name.className = 'name-tag vfd-glow';
            name.innerText = p.name;
            div.appendChild(name);

            const gridContainer = document.createElement('div');
            gridContainer.className = 'pixel-grid-container';
            const grid = document.createElement('div');
            grid.className = 'pixel-grid';
            gridContainer.appendChild(grid);
            div.appendChild(gridContainer);

            return div;
        }

        function updatePonyAnimation(p, el) {
            const gridEl = el.querySelector('.pixel-grid-container .pixel-grid');
            
            if (!p.frameTimer) p.frameTimer = 0;
            if (!p.currentFrame) p.currentFrame = 0;

            const isMoving = p.state !== 'idle' && p.state !== 'finished';
            
            if (isMoving) {
                p.frameTimer++;
                if (p.frameTimer > 10) { 
                    p.currentFrame = (p.currentFrame + 1) % 2;
                    p.frameTimer = 0;
                    renderPixels(gridEl, p);
                }
            } else {
                if (p.currentFrame !== 0) {
                    p.currentFrame = 0;
                    renderPixels(gridEl, p);
                }
            }
            if (gridEl.children.length === 0) {
                renderPixels(gridEl, p);
            }
        }

        function renderPixels(gridEl, p) {
            const frame1 = p.pixels;
            let frame2 = frame1.map((row, y) => {
                if (y < 6) { 
                    return y > 0 ? frame1[y-1] : [0,0,0,0,0,0,0,0];
                } else { 
                    let newRow = [...row];
                    const shift = 2;
                    for(let i=0; i<8; i++) {
                        newRow[i] = row[(i+3)%8];
                    }
                    return newRow;
                }
            });
            if (p.state === 'eating') {
               frame2 = frame1.map((row, y) => {
                   if (y >= 1 && y <= 4) return frame1[y-1];
                   if (y===0) return [0,0,0,0,0,0,0,0];
                   return row;
               });
            }

            const currentData = p.currentFrame === 0 ? frame1 : frame2;
            
            let html = '';
            for(let y=0; y<8; y++) {
                for(let x=0; x<8; x++) {
                    if (currentData[y][x]) {
                        html += `<div class="pixel" style="background-color: ${p.color}; box-shadow: 0 0 4px ${p.color}; grid-column: ${x+1}; grid-row: ${y+1};"></div>`;
                    }
                }
            }
            gridEl.innerHTML = html;
        }

        function createPony(name, pixels, color) {
            const id = 'p-' + Date.now() + '-' + Math.random();
            
            if (ponies.length >= 10) {
                const winnerIdx = ponies.findIndex(p => p.hasCrown);
                const removeIdx = ponies.findIndex(p => !p.hasCrown);
                if (removeIdx !== -1) ponies.splice(removeIdx, 1);
                else ponies.shift();
            }

            ponies.forEach(p => {
                p.state = 'racing';
                p.x = 20;
                p.y = 20 + Math.random() * (SCREEN_HEIGHT - PONY_HEIGHT - 40);
                p.speed = 1.5 + Math.random() * 2.0;
                p.hasCrown = false;
                p.targetX = null;
            });

            const newPony = {
                id,
                name: name || getRandomName(),
                x: 20,
                y: 20 + Math.random() * (SCREEN_HEIGHT - PONY_HEIGHT - 40),
                facing: 'right',
                state: 'racing',
                speed: 1.5 + Math.random() * 2.0,
                hasCrown: false,
                color: color || COLORS.TURQUOISE,
                pixels: JSON.parse(JSON.stringify(pixels || DEFAULT_FRAME_1)),
                timer: 0
            };
            ponies.push(newPony);
            
            grass = [];
        }

        function savePony() {
            const name = document.getElementById('editor-name').value;
            createPony(name, editorGrid, selectedColor);
            closeEditor();
        }

        function getRandomName() {
            const names = ["PIXEL", "VFD", "GLOW", "NEON", "BIT", "BYTE", "ECHO", "FLUX", "SYNC", "WAVE", "DATA", "ZAP"];
            return names[Math.floor(Math.random() * names.length)];
        }

        function openEditor() {
            document.getElementById('modal-editor').classList.remove('hidden');
        }
        function closeEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
        }
        function clearEditor() {
            editorGrid = Array(8).fill(0).map(() => Array(8).fill(0));
            renderEditorGrid('desktop-editor-grid', editorGrid);
        }
        
        function clearMobileEditor() {
            mobileEditorGrid = Array(8).fill(0).map(() => Array(8).fill(0));
            renderEditorGrid('mobile-editor-grid', mobileEditorGrid);
        }

        function buildColorPicker(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            Object.values(COLORS).forEach(c => {
                if (c === COLORS.GOLD) return;
                const div = document.createElement('div');
                div.className = 'color-dot';
                div.style.backgroundColor = c;
                div.style.boxShadow = `0 0 5px ${c}`;
                if (c === selectedColor) div.classList.add('selected');
                div.onclick = () => {
                    selectedColor = c;
                    document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    document.querySelectorAll('.color-dot').forEach(el => {
                        if (el.style.backgroundColor === c) el.classList.add('selected');
                    });
                    
                    if (containerId === 'desktop-color-picker') renderEditorGrid('desktop-editor-grid', editorGrid);
                    else renderEditorGrid('mobile-editor-grid', mobileEditorGrid);
                };
                container.appendChild(div);
            });
        }

        function buildEditorGrid(containerId, gridData) {
            renderEditorGrid(containerId, gridData);
            
            if (containerId === 'mobile-editor-grid') {
                const gridEl = document.getElementById(containerId);
                let isTouching = false;
                // 默认 1（画笔），如果第一下点到了有颜色的，变成 0（橡皮擦）
                let drawMode = 1; 

                const handleTouch = (e) => {
                    if (e.cancelable) e.preventDefault(); // 防止滚动
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    
                    if (target && target.classList.contains('editor-cell')) {
                        const r = parseInt(target.dataset.r);
                        const c = parseInt(target.dataset.c);

                        // 如果是刚开始触摸，决定是画笔还是橡皮擦
                        if (e.type === 'touchstart') {
                            drawMode = mobileEditorGrid[r][c] ? 0 : 1;
                        }

                        // 只有状态改变时才更新，优化性能
                        if (mobileEditorGrid[r][c] !== drawMode) {
                            mobileEditorGrid[r][c] = drawMode;
                            // 直接操作 DOM，不重绘整个网格，极快！
                            if (drawMode) {
                                target.classList.add('active');
                                target.style.backgroundColor = selectedColor;
                                target.style.boxShadow = `0 0 4px ${selectedColor}`;
                            } else {
                                target.classList.remove('active');
                                target.style.backgroundColor = '';
                                target.style.boxShadow = '';
                            }
                        }
                    }
                };

                gridEl.addEventListener('touchstart', (e) => {
                    isTouching = true;
                    handleTouch(e);
                }, { passive: false });

                gridEl.addEventListener('touchmove', (e) => {
                    if (isTouching) handleTouch(e);
                }, { passive: false });

                gridEl.addEventListener('touchend', () => {
                    isTouching = false;
                });
            }
        }

        function renderEditorGrid(containerId, gridData) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            gridData.forEach((row, r) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'editor-row';
                row.forEach((val, c) => {
                    const cell = document.createElement('div');
                    cell.className = 'editor-cell';
                    // 标记坐标，供 touchmove 使用
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    
                    if (val) {
                        cell.classList.add('active');
                        cell.style.backgroundColor = selectedColor;
                        cell.style.boxShadow = `0 0 4px ${selectedColor}`;
                    }
                    // 桌面鼠标事件
                    cell.onmousedown = () => togglePixel(r, c, containerId, gridData);
                    cell.onmouseenter = (e) => { if(e.buttons === 1) togglePixel(r, c, containerId, gridData, true); }
                    rowDiv.appendChild(cell);
                });
                container.appendChild(rowDiv);
            });
        }

        function togglePixel(r, c, containerId, gridData, isDrag) {
            if (isDrag) {
                gridData[r][c] = 1;
            } else {
                gridData[r][c] = gridData[r][c] ? 0 : 1;
            }
            renderEditorGrid(containerId, gridData);
        }

        function generateFixedQR() {
            if (!peerId) return;
            const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?connectTo=${peerId}`;
            
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: url,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function initMobile(hostId) {
            buildColorPicker('mobile-color-picker');
            
            // 修复：先创建容器
            const container = document.getElementById('mobile-editor-container');
            container.innerHTML = '<div id="mobile-editor-grid" class="editor-grid"></div>';
            
            buildEditorGrid('mobile-editor-grid', mobileEditorGrid);

            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);
                conn.on('open', () => {
                    document.getElementById('mobile-status').innerText = "CONNECTED";
                    document.getElementById('mobile-status').style.background = "#004d40";
                });
                conn.on('error', () => {
                    document.getElementById('mobile-status').innerText = "ERROR";
                    document.getElementById('mobile-status').style.background = "red";
                });
            });
        }

        function sendPonyFromMobile() {
            if (!conn) return;
            const name = document.getElementById('mobile-name-input').value || "MOBILE";
            conn.send({
                name: name,
                pixels: JSON.parse(JSON.stringify(mobileEditorGrid)), 
                color: selectedColor
            });
            alert("Sent!");
        }

        init();

    </script>
</body>
</html>
