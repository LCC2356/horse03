<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HORSE RUNRUN</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg: #111;
            --color-primary: #40e0d0; /* Turquoise */
            --color-panel: #004d40;
            --color-border: #00695c;
            --color-border-dark: #00251a;
            --scale: 4px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            font-family: 'VT323', monospace;
            color: var(--color-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 通用样式类 */
        .hidden { display: none !important; }
        .vfd-glow { text-shadow: 0 0 5px rgba(64, 224, 208, 0.6), 0 0 10px rgba(64, 224, 208, 0.4); }
        .btn {
            background: #00251a;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            padding: 10px 20px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(64, 224, 208, 0.2);
            transition: all 0.2s;
        }
        .btn:hover { background: var(--color-primary); color: #00251a; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 背景网格 */
        .bg-grid {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            pointer-events: none;
            background-image: linear-gradient(var(--color-border) 1px, transparent 1px), 
                              linear-gradient(90deg, var(--color-border) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }

        /* --- 布局容器 --- */
        #main-layout {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transform-origin: center;
            transform: scale(1);
        }

        /* --- 主屏幕区域 (左侧) --- */
        #game-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .screen-frame {
            width: 900px; 
            height: 120px;
            background: var(--color-panel);
            border-top: 1px solid var(--color-border);
            border-left: 1px solid var(--color-border);
            border-right: 4px solid var(--color-border-dark);
            border-bottom: 4px solid var(--color-border-dark);
            position: relative;
            border-radius: 4px;
            box-shadow: 0 0 50px rgba(64, 224, 208, 0.1);
        }

        .screen-glass {
            position: absolute;
            inset: 2px;
            background: #000;
            border: 1px solid #222;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }

        .screen-grid {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            background-image: radial-gradient(var(--color-primary) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* 装饰螺丝 */
        .screw {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #1a1c20;
            border: 1px solid var(--color-border);
            border-radius: 50%;
        }
        .tl { top: 2px; left: 2px; } .tr { top: 2px; right: 2px; }
        .bl { bottom: 2px; left: 2px; } .br { bottom: 2px; right: 2px; }

        /* 起跑线 */
        .start-line {
            position: absolute;
            top: 0; bottom: 0; left: 12px;
            width: 1px;
            border-left: 2px dashed rgba(64, 224, 208, 0.3);
        }

        /* HUD */
        .hud {
            position: absolute;
            bottom: 4px; right: 8px;
            font-size: 10px;
            opacity: 0.4;
            letter-spacing: 2px;
        }

        /* --- 二维码区域 (右侧) --- */
        #qr-section {
            height: 120px;
            display: flex;
            /* 改为横向排列，文字在左，二维码在右 */
            flex-direction: row; 
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            border: 2px solid var(--color-border);
            background: rgba(0, 37, 26, 0.8);
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(64, 224, 208, 0.1);
        }

        .qr-text-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        #qrcode {
            background: white;
            padding: 5px;
            /* 【修改点1】强制正方形，大小适中 */
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; /* 防止被挤压 */
        }
        
        #qrcode img {
            /* 【修改点1】强制填满容器 */
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        .qr-text {
            font-size: 1.1rem;
            color: var(--color-primary);
            line-height: 1.2;
            letter-spacing: 1px;
        }

        .qr-sub-text {
            font-size: 0.8rem;
            color: var(--color-primary);
            opacity: 0.7;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        /* --- 实体 (小马/草) --- */
        .entity {
            position: absolute;
            will-change: transform;
        }

        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 32px; /* 8 cols * 4px scale */
            height: 32px;
        }
        
        .pixel {
            width: 4px;
            height: 4px;
        }

        /* 【修改点2】像素皇冠容器 */
        .crown-container {
            position: absolute;
            top: -28px; /* 调整位置 */
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            animation: bounce 1s infinite;
            z-index: 10;
        }

        .name-tag {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
            opacity: 0.8;
        }

        .grass {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: #69f0ae;
            box-shadow: 0 0 4px #69f0ae;
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -5px); }
        }

        /* --- 模态框 --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1c20;
            border: 2px solid var(--color-primary);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(64, 224, 208, 0.3);
            text-align: center;
            max-width: 90%;
        }

        /* 绘图编辑器 */
        .editor-grid {
            display: grid;
            grid-template-rows: repeat(8, 1fr);
            gap: 1px;
            background: #222;
            padding: 4px;
            border: 1px solid var(--color-border);
            margin: 20px auto;
            width: fit-content;
        }
        .editor-row { display: flex; gap: 1px; }
        .editor-cell {
            width: 30px;
            height: 30px;
            background: #001a15;
            border: 1px solid #333;
            cursor: pointer;
        }
        .editor-cell.active {
            opacity: 1;
            box-shadow: 0 0 4px currentColor;
        }

        .color-picker {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.selected { border-color: white; transform: scale(1.2); }

        /* 移动端视图 */
        #mobile-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #000;
            padding: 20px;
        }

        /* 输入框 */
        input[type="text"] {
            background: #00251a;
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            padding: 8px;
            font-family: inherit;
            text-align: center;
            font-size: 1.2rem;
            width: 200px;
            margin-bottom: 10px;
        }
        input:focus { outline: none; border-color: var(--color-primary); }

    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <div id="desktop-view">
        <div id="main-layout">
            
            <div id="game-section">
                <div id="game-container">
                    <div class="screen-frame">
                        <div class="screw tl"></div><div class="screw tr"></div>
                        <div class="screw bl"></div><div class="screw br"></div>
                        
                        <div class="screen-glass" id="screen-glass">
                            <div class="screen-grid"></div>
                            <div class="start-line"></div>
                            <div class="hud">MODE:RACE // STATUS:LIVE</div>
                            
                            <div id="grass-layer"></div>
                            <div id="pony-layer"></div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="openEditor()">+ NEW RUNNER</button>
                </div>
            </div>

            <div id="qr-section">
                <div class="qr-text-group">
                    <div class="qr-text">SCAN TO JOIN</div>
                    <div class="qr-sub-text">MOBILE LINK</div>
                </div>
                <div id="qrcode"></div>
            </div>

        </div>
    </div>

    <div id="mobile-view" class="hidden">
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--color-border); padding-bottom: 10px;">
            <span style="font-size: 1.5rem;" class="vfd-glow">REMOTE DRAW</span>
            <span id="mobile-status" style="background: #004d40; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">CONNECTING</span>
        </div>
        
        <div style="flex: 1; display: flex; justify-content: center; align-items: center; overflow: auto;">
            <div id="mobile-editor-container"></div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
            <div class="color-picker" id="mobile-color-picker"></div>
            <input type="text" id="mobile-name-input" placeholder="NAME" maxlength="8">
            <button class="btn" style="width: 100%;" onclick="sendPonyFromMobile()">CAST TO SCREEN</button>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="vfd-glow" style="margin-top: 0;">// ENTITY DESIGNER</h2>
            <input type="text" id="editor-name" placeholder="NAME" maxlength="8" value="CUSTOM">
            
            <div class="color-picker" id="desktop-color-picker"></div>
            
            <div id="desktop-editor-grid" class="editor-grid"></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn" style="border-color: #ff5252; color: #ff5252;" onclick="clearEditor()">CLEAR</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="border-color: transparent;" onclick="closeEditor()">CANCEL</button>
                    <button class="btn" onclick="savePony()">CREATE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 常量与配置 ---
        const SCREEN_WIDTH = 900; // 对应 CSS .screen-frame 的宽度
        const SCREEN_HEIGHT = 120;
        const PONY_SCALE = 4;
        const PONY_WIDTH = 8 * PONY_SCALE; // 8x8 Grid
        const PONY_HEIGHT = 8 * PONY_SCALE;
        
        const COLORS = {
            TURQUOISE: '#40e0d0',
            AMBER: '#ffb300',
            RED: '#ff5252',
            GREEN: '#69f0ae',
            PURPLE: '#e040fb',
            WHITE: '#ffffff',
            GOLD: '#facc15' // 皇冠颜色
        };

        // --- 默认像素画 (8x8) ---
        const DEFAULT_FRAME_1 = [
            [0,0,0,0,0,1,0,0],
            [0,0,0,0,1,1,1,1],
            [0,0,0,0,1,1,1,0],
            [0,0,1,1,1,1,1,0],
            [1,0,1,1,1,1,1,0],
            [1,1,1,1,1,1,1,0],
            [0,0,1,0,0,0,1,0],
            [0,0,1,0,0,0,1,0]
        ];

        // 【修改点2】像素皇冠数据 (8x8)
        const CROWN_PIXELS = [
            [1,0,1,0,1,0,1,0],
            [1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1],
            [0,1,1,1,1,1,1,0],
            [0,0,1,1,1,1,0,0],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0]
        ];

        // --- 状态管理 ---
        let ponies = []; // { id, name, x, y, state, speed, hasCrown, color, pixels, facing, timer, targetX }
        let grass = [];  // { id, x, y }
        let peerId = null;
        let peer = null;
        let conn = null; // 移动端用
        
        // 编辑器状态
        // 【修改点3】初始化时也需要深拷贝，防止修改默认值
        let editorGrid = JSON.parse(JSON.stringify(DEFAULT_FRAME_1));
        let selectedColor = COLORS.TURQUOISE;

        // --- 初始化 ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            const connectTo = params.get('connectTo');

            if (connectTo) {
                // 移动端模式
                document.getElementById('desktop-view').classList.add('hidden');
                document.getElementById('mobile-view').classList.remove('hidden');
                initMobile(connectTo);
            } else {
                // 桌面端模式
                initDesktop();
            }
        }

        // --- 桌面端逻辑 ---
        function initDesktop() {
            initPeerHost();
            buildColorPicker('desktop-color-picker');
            buildEditorGrid('desktop-editor-grid');
            
            // 游戏循环
            requestAnimationFrame(gameLoop);
        }

        function initPeerHost() {
            peer = new Peer();
            peer.on('open', (id) => {
                peerId = id;
                // 生成并显示固定二维码
                generateFixedQR();
            });
            peer.on('connection', (c) => {
                c.on('data', (data) => {
                    // 收到手机端发来的小马
                    createPony(data.name, data.pixels, data.color);
                });
            });
        }

        // --- 游戏主循环 (物理引擎) ---
        function gameLoop() {
            updatePhysics();
            render();
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics() {
            // 检查比赛是否还有人没跑完
            const totalPonies = ponies.length;
            const finishedPonies = ponies.filter(p => p.state === 'finished').length;
            const isRaceOngoing = ponies.some(p => p.state === 'racing');
            
            // 全员到达终点触发器
            let allFinishedTrigger = (totalPonies > 0 && finishedPonies === totalPonies);

            // 1. 生成草 (比赛结束后)
            if (!isRaceOngoing && totalPonies > 0 && grass.length < 8 && Math.random() < 0.01) {
                grass.push({
                    id: Math.random(),
                    x: 20 + Math.random() * (SCREEN_WIDTH - 40),
                    y: 40 + Math.random() * (SCREEN_HEIGHT - 60)
                });
            }

            // 2. 更新每只小马
            let winnerFoundThisFrame = false;
            const existingWinner = ponies.some(p => p.hasCrown);

            ponies.forEach(p => {
                // 如果所有马都跑完了，重置为散步
                if (allFinishedTrigger && p.state === 'finished') {
                    p.state = 'roaming';
                    p.timer = 0;
                    p.targetX = null;
                    
                    // 全方位随机出生
                    const side = Math.floor(Math.random() * 4); // 0:Top, 1:Right, 2:Bottom, 3:Left
                    const SAFE_TOP = 35; 
                    const SAFE_H = SCREEN_HEIGHT - PONY_HEIGHT - 10 - SAFE_TOP;
                    
                    if (side === 0) { p.x = 20 + Math.random() * (SCREEN_WIDTH - 100); p.y = -50; }
                    else if (side === 1) { p.x = SCREEN_WIDTH + 10; p.y = SAFE_TOP + Math.random() * SAFE_H; }
                    else if (side === 2) { p.x = 20 + Math.random() * (SCREEN_WIDTH - 100); p.y = SCREEN_HEIGHT + 10; }
                    else { p.x = -50; p.y = SAFE_TOP + Math.random() * SAFE_H; }
                }

                // 状态机
                if (p.state === 'racing') {
                    // 速度波动 (0.5x - 2.0x)
                    let variance = 0.5 + Math.random() * 1.5;
                    p.x += p.speed * variance;
                    p.facing = 'right';

                    // 冲过屏幕右侧
                    if (p.x > SCREEN_WIDTH + 20) {
                        p.state = 'finished';
                        // 判定冠军
                        if (!existingWinner && !winnerFoundThisFrame) {
                            p.hasCrown = true;
                            winnerFoundThisFrame = true;
                        }
                    }
                } 
                else if (p.state === 'finished') {
                    p.x += 0.1; // 保持稍微移动，不要完全静止
                }
                else if (p.state === 'roaming') {
                    // 寻找最近的草
                    let targetGrass = null;
                    let minDist = 150;
                    
                    grass.forEach(g => {
                        const dx = g.x - p.x;
                        const dy = g.y - p.y;
                        const d = Math.sqrt(dx*dx + dy*dy);
                        if (d < minDist) {
                            minDist = d;
                            targetGrass = g;
                        }
                    });

                    if (targetGrass) {
                        p.state = 'walking_to_food';
                    } else {
                        // 随机游荡
                        handleRoamingMovement(p);
                    }
                }
                else if (p.state === 'walking_to_food') {
                    // 重新找一下最近的草
                    let closest = null; 
                    let d = 9999;
                    grass.forEach(item => {
                        let dist = Math.sqrt(Math.pow(item.x - p.x, 2) + Math.pow(item.y - p.y, 2));
                        if(dist < d) { d = dist; closest = item; }
                    });

                    if (!closest) {
                        p.state = 'roaming';
                    } else {
                        const dx = closest.x - p.x;
                        const dy = closest.y - p.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        if (dist < 5) {
                            p.state = 'eating';
                            p.timer = 100;
                            // 吃掉草
                            grass = grass.filter(item => item !== closest);
                        } else {
                            p.x += (dx/dist) * 1.0;
                            p.y += (dy/dist) * 1.0;
                            p.facing = dx > 0 ? 'right' : 'left';
                        }
                    }
                }
                else if (p.state === 'eating') {
                    if (p.timer > 0) p.timer--;
                    else p.state = 'roaming';
                }
            });

            // 数量限制清理 (比赛结束后清理)
            if (!isRaceOngoing && ponies.length > 10) {
                const winner = ponies.find(p => p.hasCrown);
                const others = ponies.filter(p => !p.hasCrown);
                const keepCount = winner ? 9 : 10;
                // 保留最新的
                const keptOthers = others.slice(-keepCount);
                ponies = winner ? [...keptOthers, winner] : keptOthers;
            }
        }

        function handleRoamingMovement(p) {
            // 越界弹回
            if (p.x < -50 || p.x > SCREEN_WIDTH || p.y < -50 || p.y > SCREEN_HEIGHT) {
                const dx = (SCREEN_WIDTH/2) - p.x;
                const dy = (SCREEN_HEIGHT/2) - p.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                p.x += (dx/len) * 1.5;
                p.y += (dy/len) * 1.5;
                p.facing = dx > 0 ? 'right' : 'left';
                return;
            }

            if (p.timer > 0) {
                p.timer--;
            } else {
                // 决策
                if (Math.random() > 0.3) {
                    p.targetX = Math.random() * (SCREEN_WIDTH - 40);
                    p.timer = 60 + Math.random() * 100;
                } else {
                    p.state = 'eating'; // 假装吃空气/休息
                    p.timer = 60;
                }
            }

            if (p.targetX !== undefined && p.targetX !== null) {
                const dist = p.targetX - p.x;
                if (Math.abs(dist) > 2) {
                    p.x += Math.sign(dist) * 0.5;
                    p.facing = dist > 0 ? 'right' : 'left';
                } else {
                    p.targetX = null;
                }
            }

            // 垂直抖动
            if (Math.random() < 0.05) {
                p.y += (Math.random() - 0.5) * 2;
                if (p.y < 35) p.y = 35;
                if (p.y > SCREEN_HEIGHT - 40) p.y = SCREEN_HEIGHT - 40;
            }
        }

        // --- 渲染 ---
        function render() {
            const ponyLayer = document.getElementById('pony-layer');
            const grassLayer = document.getElementById('grass-layer');
            
            // 渲染草
            grassLayer.innerHTML = '';
            grass.forEach(g => {
                const el = document.createElement('div');
                el.className = 'grass';
                el.style.transform = `translate3d(${g.x}px, ${g.y}px, 0)`;
                grassLayer.appendChild(el);
            });

            // 渲染小马
            const existingNodes = Array.from(ponyLayer.children);
            const activeIds = new Set(ponies.map(p => p.id));

            // 删除
            existingNodes.forEach(node => {
                if (!activeIds.has(node.id)) node.remove();
            });

            // 更新或创建
            ponies.forEach(p => {
                let el = document.getElementById(p.id);
                if (!el) {
                    el = createPonyDOM(p);
                    ponyLayer.appendChild(el);
                }
                
                // 更新位置
                el.style.transform = `translate3d(${p.x}px, ${p.y}px, 0)`;
                el.style.zIndex = Math.floor(p.y);

                // 更新朝向
                const pixelContainer = el.querySelector('.pixel-grid-container');
                if (p.facing === 'left') {
                    pixelContainer.style.transform = 'scaleX(-1)';
                } else {
                    pixelContainer.style.transform = 'scaleX(1)';
                }

                // 修复皇冠显示逻辑
                const crownContainer = el.querySelector('.crown-container');
                // 使用 classList 来切换 hidden 类
                if (p.hasCrown) {
                    crownContainer.classList.remove('hidden');
                } else {
                    crownContainer.classList.add('hidden');
                }

                // 名字颜色
                const nameEl = el.querySelector('.name-tag');
                nameEl.style.color = p.hasCrown ? COLORS.GOLD : p.color;
                nameEl.style.opacity = p.hasCrown ? 1 : 0.8;

                // 动画帧更新
                updatePonyAnimation(p, el);
            });
        }

        function createPonyDOM(p) {
            const div = document.createElement('div');
            div.id = p.id;
            div.className = 'entity';
            div.style.width = PONY_WIDTH + 'px';
            div.style.height = PONY_HEIGHT + 'px';

            // 【修改点2】创建像素皇冠容器
            const crownContainer = document.createElement('div');
            crownContainer.className = 'crown-container hidden'; // 默认隐藏
            
            // 创建皇冠的像素网格
            const crownGrid = document.createElement('div');
            crownGrid.className = 'pixel-grid';
            // 渲染皇冠像素
            let crownHtml = '';
            for(let y=0; y<8; y++) {
                for(let x=0; x<8; x++) {
                    if (CROWN_PIXELS[y][x]) {
                        crownHtml += `<div class="pixel" style="background-color: ${COLORS.GOLD}; box-shadow: 0 0 4px ${COLORS.GOLD}; grid-column: ${x+1}; grid-row: ${y+1};"></div>`;
                    }
                }
            }
            crownGrid.innerHTML = crownHtml;
            crownContainer.appendChild(crownGrid);
            div.appendChild(crownContainer);

            // 名字
            const name = document.createElement('div');
            name.className = 'name-tag vfd-glow';
            name.innerText = p.name;
            div.appendChild(name);

            // 像素网格容器 (用于翻转)
            const gridContainer = document.createElement('div');
            gridContainer.className = 'pixel-grid-container';
            
            // 像素网格
            const grid = document.createElement('div');
            grid.className = 'pixel-grid';
            gridContainer.appendChild(grid);
            div.appendChild(gridContainer);

            return div;
        }

        function updatePonyAnimation(p, el) {
            const gridEl = el.querySelector('.pixel-grid-container .pixel-grid');
            
            if (!p.frameTimer) p.frameTimer = 0;
            if (!p.currentFrame) p.currentFrame = 0;

            const isMoving = p.state !== 'idle' && p.state !== 'finished';
            
            if (isMoving) {
                p.frameTimer++;
                if (p.frameTimer > 10) { // 约 150ms
                    p.currentFrame = (p.currentFrame + 1) % 2;
                    p.frameTimer = 0;
                    renderPixels(gridEl, p);
                }
            } else {
                if (p.currentFrame !== 0) {
                    p.currentFrame = 0;
                    renderPixels(gridEl, p);
                }
            }
            // 第一次渲染
            if (gridEl.children.length === 0) {
                renderPixels(gridEl, p);
            }
        }

        function renderPixels(gridEl, p) {
            const frame1 = p.pixels;
            let frame2 = frame1.map((row, y) => {
                if (y < 6) { // 身体部分，下沉
                    return y > 0 ? frame1[y-1] : [0,0,0,0,0,0,0,0];
                } else { // 腿部分
                    let newRow = [...row];
                    const shift = 2;
                    for(let i=0; i<8; i++) {
                        newRow[i] = row[(i+3)%8];
                    }
                    return newRow;
                }
            });
            if (p.state === 'eating') {
               frame2 = frame1.map((row, y) => {
                   if (y >= 1 && y <= 4) return frame1[y-1];
                   if (y===0) return [0,0,0,0,0,0,0,0];
                   return row;
               });
            }

            const currentData = p.currentFrame === 0 ? frame1 : frame2;
            
            let html = '';
            for(let y=0; y<8; y++) {
                for(let x=0; x<8; x++) {
                    if (currentData[y][x]) {
                        html += `<div class="pixel" style="background-color: ${p.color}; box-shadow: 0 0 4px ${p.color}; grid-column: ${x+1}; grid-row: ${y+1};"></div>`;
                    }
                }
            }
            gridEl.innerHTML = html;
        }

        // --- 交互逻辑 ---
        function createPony(name, pixels, color) {
            const id = 'p-' + Date.now() + '-' + Math.random();
            
            // 限制数量
            if (ponies.length >= 10) {
                const winnerIdx = ponies.findIndex(p => p.hasCrown);
                const removeIdx = ponies.findIndex(p => !p.hasCrown);
                if (removeIdx !== -1) ponies.splice(removeIdx, 1);
                else ponies.shift();
            }

            // 重置现有小马到起点
            ponies.forEach(p => {
                p.state = 'racing';
                p.x = 20;
                p.y = 20 + Math.random() * (SCREEN_HEIGHT - PONY_HEIGHT - 40);
                p.speed = 1.5 + Math.random() * 2.0;
                p.hasCrown = false;
                p.targetX = null;
            });

            // 添加新小马
            const newPony = {
                id,
                name: name || getRandomName(),
                x: 20,
                y: 20 + Math.random() * (SCREEN_HEIGHT - PONY_HEIGHT - 40),
                facing: 'right',
                state: 'racing',
                speed: 1.5 + Math.random() * 2.0,
                hasCrown: false,
                color: color || COLORS.TURQUOISE,
                // 【修改点3】关键修复：使用 JSON.parse(JSON.stringify()) 进行深拷贝
                // 确保每只小马的像素数据是独立的
                pixels: JSON.parse(JSON.stringify(pixels || DEFAULT_FRAME_1)),
                timer: 0
            };
            ponies.push(newPony);
            
            // 清除草
            grass = [];
        }

        function savePony() {
            const name = document.getElementById('editor-name').value;
            // 这里的 editorGrid 已经是深拷贝过的，可以直接用
            createPony(name, editorGrid, selectedColor);
            closeEditor();
        }

        // --- 辅助功能 ---
        function getRandomName() {
            const names = ["PIXEL", "VFD", "GLOW", "NEON", "BIT", "BYTE", "ECHO", "FLUX", "SYNC", "WAVE", "DATA", "ZAP"];
            return names[Math.floor(Math.random() * names.length)];
        }

        // --- 编辑器 UI 逻辑 ---
        function openEditor() {
            document.getElementById('modal-editor').classList.remove('hidden');
        }
        function closeEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
        }
        function clearEditor() {
            editorGrid = Array(8).fill(0).map(() => Array(8).fill(0));
            renderEditorGrid('desktop-editor-grid');
        }

        function buildColorPicker(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            Object.values(COLORS).forEach(c => {
                // 不显示金色在选择器中
                if (c === COLORS.GOLD) return;

                const div = document.createElement('div');
                div.className = 'color-dot';
                div.style.backgroundColor = c;
                div.style.boxShadow = `0 0 5px ${c}`;
                if (c === selectedColor) div.classList.add('selected');
                div.onclick = () => {
                    selectedColor = c;
                    document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    if (containerId === 'desktop-color-picker') renderEditorGrid('desktop-editor-grid');
                    else renderEditorGrid('mobile-editor-grid');
                };
                container.appendChild(div);
            });
        }

        function buildEditorGrid(containerId) {
            renderEditorGrid(containerId);
        }

        function renderEditorGrid(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            editorGrid.forEach((row, r) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'editor-row';
                row.forEach((val, c) => {
                    const cell = document.createElement('div');
                    cell.className = 'editor-cell';
                    if (val) {
                        cell.classList.add('active');
                        cell.style.backgroundColor = selectedColor;
                        cell.style.boxShadow = `0 0 4px ${selectedColor}`;
                    }
                    cell.onmousedown = () => togglePixel(r, c, containerId);
                    cell.onmouseenter = (e) => { if(e.buttons === 1) togglePixel(r, c, containerId, true); }
                    rowDiv.appendChild(cell);
                });
                container.appendChild(rowDiv);
            });
        }

        function togglePixel(r, c, containerId, isDrag) {
            if (isDrag) {
                editorGrid[r][c] = 1;
            } else {
                editorGrid[r][c] = editorGrid[r][c] ? 0 : 1;
            }
            renderEditorGrid(containerId);
        }

        // --- 二维码逻辑 (修改为固定生成) ---
        function generateFixedQR() {
            if (!peerId) return;
            const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?connectTo=${peerId}`;
            
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: url,
                // 【修改点1】设置二维码大小为 90x90，留一点边距
                width: 90,
                height: 90,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- 移动端逻辑 ---
        function initMobile(hostId) {
            buildColorPicker('mobile-color-picker');
            const container = document.getElementById('mobile-editor-container');
            container.innerHTML = '<div id="mobile-editor-grid" class="editor-grid"></div>';
            // 【修改点3】确保移动端编辑器也使用深拷贝的默认值
            editorGrid = JSON.parse(JSON.stringify(DEFAULT_FRAME_1));
            renderEditorGrid('mobile-editor-grid');

            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);
                conn.on('open', () => {
                    document.getElementById('mobile-status').innerText = "CONNECTED";
                    document.getElementById('mobile-status').style.background = "#004d40";
                });
                conn.on('error', () => {
                    document.getElementById('mobile-status').innerText = "ERROR";
                    document.getElementById('mobile-status').style.background = "red";
                });
            });
        }

        function sendPonyFromMobile() {
            if (!conn) return;
            const name = document.getElementById('mobile-name-input').value || "MOBILE";
            conn.send({
                name: name,
                // 发送前进行深拷贝，虽然在这里不是必须的，但好习惯
                pixels: JSON.parse(JSON.stringify(editorGrid)),
                color: selectedColor
            });
            alert("Sent!");
        }

        // 启动
        init();

    </script>
</body>
</html>
